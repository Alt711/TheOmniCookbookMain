---
import Layout from '../layouts/Layout.astro'
import { supabase } from '../lib/supabase'

interface Recipe {
	id: number
	title: string
	ingredients: string
}

function fmtErr(prefix: string, e: unknown) {
	const base = e as any
	return [
		prefix,
		base?.message && `message: ${base.message}`,
		base?.code && `code: ${base.code}`,
		base?.details && `details: ${base.details}`,
		base?.hint && `hint: ${base.hint}`,
		base?.name && `name: ${base.name}`,
		base?.status && `status: ${base.status}`,
	].filter(Boolean).join(' | ')
}

const url = import.meta.env.SUPABASE_URL
const key = import.meta.env.SUPABASE_ANON_KEY

console.log('[env] URL?', !!import.meta.env.SUPABASE_URL, 'KEY?', !!import.meta.env.SUPABASE_ANON_KEY)

let recipes: Recipe[] = []
let error: { message: string } | null = null

try {
	if (!url || !key) {
		throw new Error(`Missing envs: SUPABASE_URL=${!!url}, SUPABASE_ANON_KEY=${!!key}`)
	}

	// quick sanity query first (narrow 401/RLS vs schema issues)
	const ping = await supabase.from('recipes').select('id', { count: 'exact', head: true })
	if (ping.error) {
		// This catches RLS “permission denied”, table not found, etc.
		throw new Error(fmtErr('Ping failed', ping.error))
	}

	const { data, error: fetchError, status, statusText } = await supabase
		.from('recipes')
		.select('id, title, ingredients')
		.limit(25)

	if (fetchError) {
		throw new Error(fmtErr(`Select failed (status ${status} ${statusText ?? ''})`, fetchError))
	}

	recipes = data ?? []
} catch (e) {
	// also log to build output for CI debugging
	console.error('[recipes page]', e)
	error = { message: fmtErr('Caught', e) }
}
---
<Layout title="Omnicookbook">
	<h1 style="text-align:center;color:#c41e16;">Welcome to the Omnicookbook</h1>

	{error && (
		<pre style="white-space:pre-wrap;background:#fff3f3;border:1px solid #f3b5b5;padding:.75rem;border-radius:.5rem;max-width:800px;margin:1rem auto;">
      {error.message}
    </pre>
	)}

	{recipes.length > 0 ? (
		<ul style="max-width:600px;margin:1rem auto;list-style:none;padding:0;">
			{recipes.map(r => (
				<li style="background:#fff7ef;border:1px solid #ddd;border-radius:.5rem;padding:.75rem;margin:.5rem 0;">
					<strong>{r.title}</strong> — {r.ingredients}
				</li>
			))}
		</ul>
	) : (
		!error && <p style="text-align:center;">No data found.</p>
	)}
</Layout>
