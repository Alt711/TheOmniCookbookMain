---
import Layout from '../layouts/Layout.astro'
import { supabase } from '../lib/supabase'

interface Recipe {
	id: number
	title: string
	ingredients: string
}

let recipes: Recipe[] = []
let errorMessage: string | null = null

const url = import.meta.env.SUPABASE_URL
const key = import.meta.env.SUPABASE_ANON_KEY

console.log(
	'[recipes page env] URL?',
	!!url,
	'KEY?',
	!!key
)

if (!url || !key) {
	console.error('[recipes page] Missing Supabase envs', {
		hasUrl: !!url,
		hasKey: !!key
	})
	errorMessage = 'Supabase is not configured, so recipes are disabled for now.'
} else {
	try {
		const { data, error, status, statusText } = await supabase
			.from('recipes')
			.select('id, title, ingredients')
			.limit(25)

		if (error) {
			console.error(
				'[recipes page] Supabase query failed',
				{ status, statusText, error }
			)
			errorMessage = 'Could not load recipes from the database right now.'
		} else {
			recipes = data ?? []
		}
	} catch (e) {
		console.error('[recipes page] Unexpected error while loading recipes', e)
		errorMessage = 'Could not load recipes from the database right now.'
	}
}
---

<Layout title="Omnicookbook">
	<h1 style="text-align:center;color:#c41e16;">Welcome to the Omnicookbook</h1>

	{errorMessage && (
		<p style="text-align:center;color:#b00020;margin:1rem;">
			{errorMessage}
		</p>
	)}

	{recipes.length > 0 ? (
		<ul style="max-width:600px;margin:1rem auto;list-style:none;padding:0;">
			{recipes.map((r) => (
				<li
					style="background:#fff7ef;border:1px solid #ddd;border-radius:.5rem;padding:.75rem;margin:.5rem 0;"
				>
					<strong>{r.title}</strong> â€” {r.ingredients}
				</li>
			))}
		</ul>
	) : (
		!errorMessage && (
			<p style="text-align:center;">No recipes found yet.</p>
		)
	)}
</Layout>
