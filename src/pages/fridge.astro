---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import '../styles/style.css';

function fmtErr(prefix: string, e: unknown) {
    const base = e as any;
    return [
        prefix,
        base?.message && `message: ${base.message}`,
        base?.code && `code: ${base.code}`,
        base?.details && `details: ${base.details}`,
        base?.hint && `hint: ${base.hint}`,
        base?.name && `name: ${base.name}`,
        base?.status && `status: ${base.status}`,
    ].filter(Boolean).join(' | ');
}

type FoodDetails = any;
type NutrEntry = { value: number; unit: string };

const mode = Astro.url.searchParams.get('mode') === 'recipes' ? 'recipes' : 'ingredients';
const query = (Astro.url.searchParams.get('q') || '').trim() || '';
const budgetParam = (Astro.url.searchParams.get('budget') || '').trim();
const budget = budgetParam ? Number(budgetParam) : null;

const FDC_KEY = import.meta.env.FDC_API_KEY;
if (!FDC_KEY) throw new Error('Missing FDC_API_KEY (set in env)');

let food: FoodDetails | null = null;
let foodError: { message: string } | null = null;

const SPOON_KEY = import.meta.env.SPOONACULAR || '';
let recipes: any[] = [];
let recipeError: { message: string } | null = null;

if (mode === 'ingredients' && query) {
    try {
        const sUrl = new URL('https://api.nal.usda.gov/fdc/v1/foods/search');
        sUrl.searchParams.set('api_key', FDC_KEY);
        sUrl.searchParams.set('query', query);
        sUrl.searchParams.set('pageSize', '1');
        sUrl.searchParams.set('dataType', 'Branded,SR Legacy,Survey (FNDDS)');

        const sRes = await fetch(sUrl.toString());
        const sTxt = await sRes.text();
        if (!sRes.ok) throw new Error(`Search HTTP ${sRes.status} ${sRes.statusText} | ${sTxt.slice(0,200)}`);

        const sJson = JSON.parse(sTxt);
        const top = sJson?.foods?.[0];
        if (!top?.fdcId) throw new Error(`No results for "${query}"`);

        const dUrl = new URL(`https://api.nal.usda.gov/fdc/v1/food/${top.fdcId}`);
        dUrl.searchParams.set('api_key', FDC_KEY);

        const dRes = await fetch(dUrl.toString());
        const dTxt = await dRes.text();
        if (!dRes.ok) throw new Error(`Details HTTP ${dRes.status} ${dRes.statusText} | ${dTxt.slice(0,200)}`);

        food = JSON.parse(dTxt);
    } catch (e) {
        console.error('[fdc][fridge]', e);
        foodError = { message: fmtErr('USDA error', e) };
    }
}

if (mode === 'recipes' && query) {
    try {
        if (!SPOON_KEY) {
            throw new Error('Missing SPOONACULAR env var');
        }

        const rUrl = new URL('https://api.spoonacular.com/recipes/complexSearch');
        rUrl.searchParams.set('apiKey', SPOON_KEY);
        rUrl.searchParams.set('query', query);
        rUrl.searchParams.set('addRecipeInformation', 'true');
        rUrl.searchParams.set('addRecipeNutrition', 'true');
        rUrl.searchParams.set('number', '8');

        const rRes = await fetch(rUrl.toString());
        const rTxt = await rRes.text();
        if (!rRes.ok) throw new Error(`Spoonacular HTTP ${rRes.status} ${rRes.statusText} | ${rTxt.slice(0,200)}`);

        const rJson = JSON.parse(rTxt);
        recipes = rJson?.results ?? [];
    } catch (e) {
        console.error('[spoonacular][fridge]', e);
        recipeError = { message: fmtErr('Recipe error', e) };
    }
}

function buildMap(fd: any) {
    const map = new Map<string, NutrEntry>();

    for (const n of (fd?.foodNutrients ?? [])) {
        const name = n.nutrientName ?? n.nutrient?.name;
        const unit = n.unitName ?? n.nutrient?.unitName ?? '';
        const val  = n.value ?? n.amount;
        if (name != null && val != null) {
            map.set(String(name).toLowerCase(), { value: Number(val), unit });
        }
    }

    const ln = fd?.labelNutrients || {};
    const addLN = (key: string, pretty: string, unit: string) => {
        if (ln[key]?.value != null) map.set(pretty.toLowerCase(), { value: Number(ln[key].value), unit });
    };
    addLN('calories',      'Energy',                       'kcal');
    addLN('fat',           'Total lipid (fat)',            'g');
    addLN('carbohydrates', 'Carbohydrate, by difference',  'g');
    addLN('sugars',        'Sugars, total including NLEA', 'g');
    addLN('protein',       'Protein',                      'g');

    return map;
}

const NMAP = food ? buildMap(food) : new Map();

function pickAny(names: string[]): { value: number | null; unit: string } {
    for (const name of names) {
        const hit = NMAP.get(name.toLowerCase());
        if (hit) return hit;
    }
    return { value: null, unit: '' };
}

function fmt(val: number | null, unit: string) {
    if (val == null) return '‚Äî';
    const fixed = /kcal/i.test(unit) ? val.toFixed(0) : val.toFixed(1);
    return `${fixed} ${unit}`;
}

const S_ENERGY = food ? pickAny(['Energy', 'Energy (Atwater General Factors)']) : { value: null, unit: '' };
const S_PRO    = food ? pickAny(['Protein']) : { value: null, unit: '' };
const S_FAT    = food ? pickAny(['Total lipid (fat)', 'Total Fat']) : { value: null, unit: '' };
const S_CARB   = food ? pickAny(['Carbohydrate, by difference', 'Total Carbohydrate']) : { value: null, unit: '' };
const S_SUGAR  = food ? pickAny(['Sugars, total including NLEA', 'Sugars, total']) : { value: null, unit: '' };

const filteredRecipes =
    budget && !Number.isNaN(budget)
        ? recipes.filter((r: any) =>
            typeof r.pricePerServing === 'number' &&
            r.pricePerServing / 100 <= budget
        )
        : recipes;

function toHTMLList(list: any[] | undefined) {
    if (!list || !list.length) {
        return `<li class="empty-list">No ingredient list available.</li>`;
    }
    return list.map((ing) => `<li>${ing.original}</li>`).join('');
}

function toHTMLStepsFromSummary(summaryHtml: string | undefined) {
    const raw = (summaryHtml || '').replace(/<\/?a[^>]*>/g, '');
    if (!raw.trim()) {
        return `<p class="empty-instructions">No detailed instructions available.</p>`;
    }
    const maxLen = 420;
    const trimmed = raw.length > maxLen ? raw.slice(0, maxLen) + '‚Ä¶' : raw;
    return `<p class="instructions-text">${trimmed}</p>`;
}
---

<Layout title="Add ingredients to your fridge ‚Ä¢ OmniCookBook">
    <div style="overflow-x: hidden; width: 100vw; max-width: 100%; box-sizing: border-box;">
    <div id="omni-banner" class="omni-banner-fullscreen">
        <img src="/img/omnilogo.png" alt="OmniCookBook Logo" class="banner-logo" />
        <h1 class="banner-title">OmniCookBook</h1>
        <p class="banner-tagline">Your Ultimate Recipe & Nutrition Companion</p>
    </div>

    <nav class="top-bar" id="top-nav">
        <a href="/" class="page-title">
            <img src="/img/omnilogo.png" alt="logo" class="nav-logo" />
            <span class="nav-title-text">OmniCookBook</span>
            <img src="/img/omnilogo.png" alt="logo" class="nav-logo nav-logo-flip" />
        </a>

        <div class="right-side-lks">
            <a href="/" class="nav-link">Home</a>
            <a href="/about" class="nav-link">About</a>
            <a href="/contact-us" class="nav-link">Contact us</a>
        </div>
    </nav>

    <div class="myfridge-left">
        <a href="/fridge">
            <button class="myfridgebutton">My Fridge</button>
        </a>
    </div>
    <div class="mealplanner-right">
        <a href="/test">
            <button class="mealplannerbutton">Meal Planner</button>
        </a>
    </div>

    <section class="fridge-tabs-wrapper">
        <div class="fridge-tabs-bar">
            <a
                href="/fridge?mode=ingredients"
                class={`fridge-tab ${mode === 'ingredients' ? 'active' : ''}`}
            >
                üß∫ Ingredients (USDA)
            </a>
            <a
                href="/fridge?mode=recipes"
                class={`fridge-tab ${mode === 'recipes' ? 'active' : ''}`}
            >
                üìñ Recipes (Spoonacular)
            </a>
        </div>
    </section>

    {mode === 'ingredients' && (
        <>
            <p class="prompt-index">Add ingredients to your fridge</p>
            <form class="omnisearchbox" method="get" action="/fridge">
                <input type="hidden" name="mode" value="ingredients" />
                <input
                    class="omnisearchinput"
                    name="q"
                    value={query}
                    placeholder="Search for an ingredient (e.g. milk, chicken breast)"
                />
                <button class="omnisearchbutton" type="submit" aria-label="Search">üîç</button>
            </form>

            {foodError && (
                <pre class="error-box">{foodError.message}</pre>
            )}

            {!foodError && !query && (
                <p class="info-text">
                    Start by searching for an ingredient above. When you find the correct item, click
                    <strong> "Add to My Fridge"</strong> to save it locally.
                </p>
            )}

            {!foodError && query && !food && (
                <p class="info-text">
                    No ingredient results found for <strong>{query}</strong>.
                </p>
            )}

            {!foodError && food && (
                <section
                    id="current-food"
                    class="food-detail-card"
                    data-name={food.description || query}
                    data-brand={food.brandOwner || ''}
                    data-kind="ingredient"
                    data-calories={S_ENERGY.value ?? ''}
                    data-protein={S_PRO.value ?? ''}
                    data-carbs={S_CARB.value ?? ''}
                    data-fat={S_FAT.value ?? ''}
                    data-sugar={S_SUGAR.value ?? ''}
                >
                    <div class="food-header">
                        <strong>{food.description || query}</strong>
                        {food.brandOwner && <> ‚Äî <em>{food.brandOwner}</em></>}
                        <div class="serving-info">
                            Serving: {food.servingSize ? `${food.servingSize} ${food.servingSizeUnit || ''}` : 'n/a'}
                        </div>
                    </div>

                    <h3 class="nutrients-heading">Per serving</h3>
                    <ul class="nutrients-list">
                        <li class="nutrient-row">
                            <span>Energy</span><span>{fmt(S_ENERGY.value, S_ENERGY.unit)}</span>
                        </li>
                        <li class="nutrient-row">
                            <span>Protein</span><span>{fmt(S_PRO.value, S_PRO.unit)}</span>
                        </li>
                        <li class="nutrient-row">
                            <span>Total fat</span><span>{fmt(S_FAT.value, S_FAT.unit)}</span>
                        </li>
                        <li class="nutrient-row">
                            <span>Carbohydrate</span><span>{fmt(S_CARB.value, S_CARB.unit)}</span>
                        </li>
                        <li class="nutrient-row">
                            <span>Sugars</span><span>{fmt(S_SUGAR.value, S_SUGAR.unit)}</span>
                        </li>
                    </ul>

                    <button id="add-to-fridge" type="button" class="btn-primary">
                        ‚ûï Add Ingredient to My Fridge
                    </button>
                </section>
            )}
        </>
    )}

    {mode === 'recipes' && (
        <>
            <p class="prompt-index">Find recipes to cook</p>
            <form class="omnisearchbox" method="get" action="/fridge">
                <input type="hidden" name="mode" value="recipes" />
                <input
                    class="omnisearchinput"
                    name="q"
                    value={query}
                    placeholder="Search for recipes (e.g. chicken alfredo, stir fry)"
                />
                <button class="omnisearchbutton" type="submit" aria-label="Search">üîç</button>
            </form>

            <div class="budget-filter-wrapper">
                <form class="budget-filter" method="get" action="/fridge">
                    <input type="hidden" name="mode" value="recipes" />
                    <input type="hidden" name="q" value={query} />
                    <label for="budget-select" class="budget-label">
                        Budget per recipe:
                    </label>
                    <select
                        id="budget-select"
                        name="budget"
                        onchange="this.form.submit()"
                        class="budget-select"
                    >
                        <option value="" selected={!budgetParam}>No budget filter</option>
                        <option value="5" selected={budget === 5}>Under $5</option>
                        <option value="10" selected={budget === 10}>Under $10</option>
                        <option value="15" selected={budget === 15}>Under $15</option>
                        <option value="20" selected={budget === 20}>Under $20</option>
                    </select>
                </form>
            </div>

            {recipeError && (
                <pre class="error-box">{recipeError.message}</pre>
            )}

            {!recipeError && !query && (
                <p class="info-text">
                    Search for recipes powered by Spoonacular. You can add recipes to your fridge and optionally
                    schedule them directly into your meal planner.
                </p>
            )}

            {!recipeError && query && recipes.length === 0 && (
                <p class="info-text">
                    No recipes found for <strong>{query}</strong>.
                </p>
            )}

            {!recipeError && query && recipes.length > 0 && filteredRecipes.length === 0 && budget && (
                <p class="info-text">
                    We found recipes for <strong>{query}</strong>, but none are under your budget of
                    ${budget.toFixed(0)} per recipe. Try increasing your budget or clearing the filter.
                </p>
            )}

            {!recipeError && filteredRecipes.length > 0 && (
                <section class="recipes-container">
                    {filteredRecipes.map((r) => {
                        const nutrients = (r.nutrition && Array.isArray(r.nutrition.nutrients))
                            ? r.nutrition.nutrients
                            : [];
                        const getAmount = (label: string) => {
                            const hit = nutrients.find((n: any) =>
                                String(n.name).toLowerCase() === label.toLowerCase()
                            );
                            return hit?.amount ?? '';
                        };
                        const cal  = getAmount('Calories');
                        const pro  = getAmount('Protein');
                        const fat  = getAmount('Fat');
                        const carb = getAmount('Carbohydrates');
                        const sug  = getAmount('Sugar');

                        const summaryHtml = r.summary || '';
                        const shortSummaryHtml = toHTMLStepsFromSummary(summaryHtml);

                        const recipeUrl = r.sourceUrl
                            || `https://spoonacular.com/recipes/${encodeURIComponent(r.title || 'recipe')}-${r.id}`;

                        return (
                        <article
                            class="recipe-card"
                            data-recipe-id={r.id}
                            data-recipe-title={r.title}
                            data-kind="recipe"
                            data-calories={cal}
                            data-protein={pro}
                            data-carbs={carb}
                            data-fat={fat}
                            data-sugar={sug}
                        >
                            <div class="recipe-content">
                                {r.image && (
                                    <img
                                        src={r.image}
                                        alt={r.title}
                                        class="recipe-image"
                                        loading="lazy"
                                    />
                                )}
                                <div class="recipe-info">
                                    <h3 class="recipe-title">{r.title}</h3>
                                    <p class="recipe-meta">
                                        {r.readyInMinutes && <>‚è± {r.readyInMinutes} min&nbsp;&nbsp;</>}
                                        {r.servings && <>üçΩ Serves {r.servings}</>}
                                        {typeof r.pricePerServing === 'number' && (
                                            <>
                                                &nbsp;&nbsp;üí≤
                                                {(r.pricePerServing / 100).toFixed(2)} per serving
                                            </>
                                        )}
                                    </p>

                                    {(cal || pro || carb || fat || sug) && (
                                        <p class="recipe-macros">
                                            {cal && <>üî• {(typeof cal === 'number' ? cal.toFixed(0) : cal)} kcal&nbsp;&nbsp;</>}
                                            {pro && <>üí™ P {(typeof pro === 'number' ? pro.toFixed(1) : pro)} g&nbsp;&nbsp;</>}
                                            {carb && <>üçû C {(typeof carb === 'number' ? carb.toFixed(1) : carb)} g&nbsp;&nbsp;</>}
                                            {fat && <>üßà F {(typeof fat === 'number' ? fat.toFixed(1) : fat)} g&nbsp;&nbsp;</>}
                                            {sug && <>üç¨ Sugars {(typeof sug === 'number' ? sug.toFixed(1) : sug)} g</>}
                                        </p>
                                    )}

                                    <details class="recipe-details">
                                        <summary>Ingredients</summary>
                                        <ul class="ingredients-list" set:html={toHTMLList(r.extendedIngredients)}></ul>
                                    </details>

                                    <details class="recipe-details">
                                        <summary>Instructions</summary>
                                        <div class="instructions-content">
                                            <div set:html={shortSummaryHtml}></div>
                                            <p class="recipe-link">
                                                <a href={recipeUrl} target="_blank" rel="noreferrer">
                                                    View full recipe on Spoonacular ‚Üó
                                                </a>
                                            </p>
                                        </div>
                                    </details>
                                </div>
                            </div>

                            <div class="recipe-actions">
                                <button type="button" class="recipe-add-fridge btn-primary">
                                    ‚ûï Add Recipe to My Fridge
                                </button>

                                <div class="recipe-planner">
                                    <label class="planner-label">
                                        Plan for:
                                        <input
                                            type="date"
                                            class="recipe-plan-date"
                                            data-recipe-id={r.id}
                                        />
                                    </label>
                                    <button
                                        type="button"
                                        class="recipe-add-plan btn-secondary"
                                        data-recipe-id={r.id}
                                    >
                                        ‚ûï Add to Meal Planner
                                    </button>
                                </div>
                            </div>
                        </article>
                        );
                    })}
                </section>
            )}
        </>
    )}

    <section class="fridge-inventory">
        <h2>My Fridge</h2>
        <p class="fridge-description">
            Items are stored in your browser only (localStorage). Clearing site data will reset this list.
        </p>
        <ul id="fridge-list" class="fridge-list"></ul>
        <button id="clear-fridge" type="button" class="btn-danger" style="display:none;">
            üóë Clear My Fridge
        </button>
    </section>

    <script type="module">
        const STORAGE_KEY = 'omni-fridge-items';
        const MP_KEY = 'omni-mealplan-monthly';

        function loadFridge() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch {
                return [];
            }
        }

        function saveFridge(items) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
        }

        function renderFridge() {
            const listEl = document.getElementById('fridge-list');
            const clearBtn = document.getElementById('clear-fridge');
            if (!listEl) return;

            const items = loadFridge();
            listEl.innerHTML = '';

            if (!items.length) {
                listEl.innerHTML = '<li class="fridge-empty">Your fridge is empty. Add something above!</li>';
                if (clearBtn) clearBtn.style.display = 'none';
                return;
            }

            for (const item of items) {
                const li = document.createElement('li');
                li.className = 'fridge-item';

                const left = document.createElement('div');
                left.className = 'fridge-item-info';

                const isRecipe = item.kind === 'recipe';
                const tag = isRecipe ? 'üìñ ' : 'üß∫ ';

                const title = document.createElement('span');
                title.className = 'fridge-item-title';
                title.textContent = tag + item.name + (item.brand ? ` ‚Äî ${item.brand}` : '');
                left.appendChild(title);

                if (item.macros) {
                    const m = item.macros;
                    const macrosLine = document.createElement('span');
                    macrosLine.className = 'fridge-item-macros';

                    const toNum = (v) => (typeof v === 'number' && !Number.isNaN(v) ? v : null);

                    const cals = toNum(m.calories);
                    const pro  = toNum(m.protein);
                    const carb = toNum(m.carbs);
                    const fat  = toNum(m.fat);
                    const sug  = toNum(m.sugar);

                    const parts = [];
                    if (cals != null) parts.push(`${cals.toFixed ? cals.toFixed(0) : cals} kcal`);
                    if (pro  != null) parts.push(`P ${pro.toFixed ? pro.toFixed(1) : pro} g`);
                    if (carb != null) parts.push(`C ${carb.toFixed ? carb.toFixed(1) : carb} g`);
                    if (fat  != null) parts.push(`F ${fat.toFixed ? fat.toFixed(1) : fat} g`);
                    if (sug  != null) parts.push(`Sugars ${sug.toFixed ? sug.toFixed(1) : sug} g`);

                    if (parts.length) {
                        macrosLine.textContent = parts.join(' ‚Ä¢ ');
                        left.appendChild(macrosLine);
                    }
                }

                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remove';
                removeBtn.className = 'btn-remove';

                removeBtn.addEventListener('click', () => {
                    const updated = loadFridge().filter((x) => x.id !== item.id);
                    saveFridge(updated);
                    renderFridge();
                });

                li.appendChild(left);
                li.appendChild(removeBtn);
                listEl.appendChild(li);
            }

            if (clearBtn) clearBtn.style.display = 'inline-block';
        }

        function loadPlan() {
            try {
                const raw = localStorage.getItem(MP_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch {
                return {};
            }
        }

        function savePlan(p) {
            localStorage.setItem(MP_KEY, JSON.stringify(p));
        }

        let hasScrolled = false;
        window.addEventListener('scroll', () => {
            const banner = document.getElementById('omni-banner');
            if (!banner || hasScrolled) return;

            if (window.scrollY > 50) {
                hasScrolled = true;
                banner.classList.remove('omni-banner-fullscreen');
                banner.classList.add('omni-banner-corner');
            }
        });

        setTimeout(() => {
            const banner = document.getElementById('omni-banner');
            if (banner && !hasScrolled) {
                hasScrolled = true;
                banner.classList.remove('omni-banner-fullscreen');
                banner.classList.add('omni-banner-corner');
            }
        }, 3000);

        document.addEventListener('DOMContentLoaded', () => {
            renderFridge();

            const addIngredientBtn = document.getElementById('add-to-fridge');
            const currentFood = document.getElementById('current-food');
            const clearBtn = document.getElementById('clear-fridge');

            if (addIngredientBtn && currentFood) {
                addIngredientBtn.addEventListener('click', () => {
                    const name = currentFood.dataset.name || 'Unknown item';
                    const brand = currentFood.dataset.brand || '';
                    const kind = currentFood.dataset.kind || 'ingredient';
                    const id = kind + '|' + name + '|' + brand;

                    const macros = {
                        calories: currentFood.dataset.calories ? Number(currentFood.dataset.calories) : null,
                        protein:  currentFood.dataset.protein  ? Number(currentFood.dataset.protein)  : null,
                        carbs:    currentFood.dataset.carbs    ? Number(currentFood.dataset.carbs)    : null,
                        fat:      currentFood.dataset.fat      ? Number(currentFood.dataset.fat)      : null,
                        sugar:    currentFood.dataset.sugar    ? Number(currentFood.dataset.sugar)    : null,
                    };

                    const items = loadFridge();
                    if (!items.find((x) => x.id === id)) {
                        items.push({ id, name, brand, kind, macros });
                        saveFridge(items);
                        renderFridge();
                    } else {
                        alert('This item is already in your fridge.');
                    }
                });
            }

            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (confirm('Clear all items from your fridge?')) {
                        saveFridge([]);
                        renderFridge();
                    }
                });
            }

            document.querySelectorAll('.recipe-add-fridge').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const card = btn.closest('.recipe-card');
                    if (!card) return;
                    const name = card.dataset.recipeTitle || 'Unknown recipe';
                    const recipeId = card.dataset.recipeId || '';
                    const kind = card.dataset.kind || 'recipe';
                    const id = 'recipe|' + recipeId;

                    const macros = {
                        calories: card.dataset.calories ? Number(card.dataset.calories) : null,
                        protein:  card.dataset.protein  ? Number(card.dataset.protein)  : null,
                        carbs:    card.dataset.carbs    ? Number(card.dataset.carbs)    : null,
                        fat:      card.dataset.fat      ? Number(card.dataset.fat)      : null,
                        sugar:    card.dataset.sugar    ? Number(card.dataset.sugar)    : null,
                    };

                    const items = loadFridge();
                    if (!items.find((x) => x.id === id)) {
                        items.push({ id, name, brand: '', kind, macros });
                        saveFridge(items);
                        renderFridge();
                    } else {
                        alert('This recipe is already in your fridge.');
                    }
                });
            });

            document.querySelectorAll('.recipe-add-plan').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const recipeId = btn.dataset.recipeId;
                    const card = btn.closest('.recipe-card');
                    if (!card || !recipeId) return;

                    const name = card.dataset.recipeTitle || 'Unknown recipe';
                    const dateInput = card.querySelector('.recipe-plan-date');
                    const dateVal = dateInput?.value;

                    if (!dateVal) {
                        alert('Please choose a date first.');
                        return;
                    }

                    const [y, m, d] = dateVal.split('-');
                    const key = `${Number(y)}-${Number(m)}-${Number(d)}`;

                    const plan = loadPlan();
                    plan[key] = plan[key] || [];

                    const id = 'recipe|' + recipeId;

                    const macros = {
                        calories: card.dataset.calories ? Number(card.dataset.calories) : null,
                        protein:  card.dataset.protein  ? Number(card.dataset.protein)  : null,
                        carbs:    card.dataset.carbs    ? Number(card.dataset.carbs)    : null,
                        fat:      card.dataset.fat      ? Number(card.dataset.fat)      : null,
                        sugar:    card.dataset.sugar    ? Number(card.dataset.sugar)    : null,
                    };

                    if (!plan[key].find((x) => x.id === id)) {
                        plan[key].push({ id, name, brand: 'Recipe', macros });
                        savePlan(plan);
                        alert('Recipe added to your meal planner for ' + dateVal);
                    } else {
                        alert('This recipe is already on your plan for that day.');
                    }
                });
            });
        });
    </script>

    <style>
:root {
    --primary: #e67e22;
    --primary-light: #f39c12;
    --primary-dark: #d35400;
    --accent: #e67e22;
    --background: #fafbfc;
    --card-bg: #ffffff;
    --border: #e1e8ed;
    --text-primary: #2d3748;
    --text-secondary: #718096;
    --success: #38a169;
    --error: #e53e3e;
    --banner-color: #df976e;
}

.omni-banner-fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--banner-color) 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

.omni-banner-corner {
    position: fixed;
    top: 1rem;
    left: 1rem;
    width: 0;
    height: 0;
    opacity: 0;
    pointer-events: none;
    z-index: 1000;
    transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

.omni-banner-fullscreen .banner-logo {
    width: 120px;
    height: 120px;
    margin-bottom: 1.5rem;
    animation: float 3s ease-in-out infinite;
}

.omni-banner-fullscreen .banner-title {
    color: white;
    font-size: 3.5rem;
    font-weight: 800;
    margin: 0;
    letter-spacing: -0.02em;
}

.omni-banner-fullscreen .banner-tagline {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.25rem;
    margin: 0.5rem 0 0 0;
    font-weight: 300;
}

.omni-banner-corner .banner-logo,
.omni-banner-corner .banner-title,
.omni-banner-corner .banner-tagline {
    display: none;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
}

.top-bar {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--banner-color) 100%);
    padding: 1.5rem 2.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 999;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    box-sizing: border-box;
}

.page-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: white;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: transform 0.2s ease;
    position: absolute;
    left: 2.5rem;
}

.right-side-lks {
    display: flex;
    gap: 0.75rem;
    position: absolute;
    right: 2.5rem;
}

.nav-link {
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
    font-size: 1.1rem;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s ease;
}

.nav-link:hover {
    background: rgba(255, 255, 255, 0.15);
    color: white;
}

.page-title:hover {
    transform: translateY(-2px);
}

.nav-logo {
    width: 40px;
    height: 40px;
}

.nav-logo-flip {
    transform: scaleX(-1);
}

.nav-title-text {
    font-size: 1.75rem;
}

.myfridge-left, .mealplanner-right {
    position: absolute;
    top: 400px;
    z-index: 998;
}

.myfridge-left {
    left: 2rem;
}

.mealplanner-right {
    right: 2rem;
}

.myfridgebutton, .mealplannerbutton {
    padding: 1rem 1.5rem;
    border-radius: 12px;
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
    font-weight: 600;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.myfridgebutton:hover, .mealplannerbutton:hover {
    background: var(--primary);
    color: white;
    transform: scale(1.05);
}

.omnisearchbox {
    max-width: 600px;
    margin: 3.5rem auto 1.5rem auto;
    position: relative;
    display: flex;
    align-items: center;
}

.omnisearchinput {
    width: 100%;
    padding: 1rem 4rem 1rem 1.5rem;
    font-size: 1rem;
    border: 2px solid var(--border);
    border-radius: 12px;
    transition: all 0.3s ease;
    background: white;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.omnisearchinput:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1), 0 4px 20px rgba(0, 0, 0, 0.08);
}

.omnisearchinput::placeholder {
    color: var(--text-secondary);
}

.omnisearchbutton {
    position: absolute;
    right: 0.5rem;
    background: var(--primary);
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 1.25rem;
}

.omnisearchbutton:hover {
    background: var(--primary-dark);
    transform: scale(1.05);
}

.omnisearchbutton:active {
    transform: scale(0.98);
}

.fridge-tabs-wrapper {
    max-width: 800px;
    margin: 7rem auto 0 auto;
    padding-top: 80px;
}

.fridge-tabs-bar {
    display: flex;
    gap: 0.5rem;
    background: white;
    padding: 0.5rem;
    border-radius: 12px;
    border: 2px solid var(--border);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.fridge-tab {
    flex: 1;
    padding: 0.875rem 1.5rem;
    border-radius: 8px;
    background: transparent;
    color: var(--text-secondary);
    font-weight: 600;
    text-decoration: none;
    text-align: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.fridge-tab:hover {
    background: rgba(255, 107, 53, 0.08);
    color: var(--primary);
}

.fridge-tab.active {
    background: var(--primary);
    color: white;
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
}

.prompt-index {
    text-align: center;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 1.5rem 0 0 0;
}

.btn-primary {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: none;
    background: var(--primary);
    color: white;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);
}

.btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
}

.btn-primary:active {
    transform: translateY(0);
}

.btn-secondary {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-secondary:hover {
    background: var(--primary);
    color: white;
}

.btn-danger {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: none;
    background: var(--error);
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(229, 62, 62, 0.2);
}

.btn-danger:hover {
    background: #c53030;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
}

.btn-remove {
    padding: 0.4rem 0.9rem;
    font-size: 0.8rem;
    border-radius: 6px;
    border: 1px solid #999;
    background: #f5f5f5;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-remove:hover {
    background: #e0e0e0;
    border-color: #666;
}

.recipes-container {
    max-width: 800px;
    margin: 1.5rem auto 1rem auto;
}

.recipe-card {
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    background: white;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.recipe-card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
    border-color: var(--primary-light);
}

.recipe-content {
    display: flex;
    gap: 1rem;
}

.recipe-image {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.recipe-info {
    flex: 1;
}

.recipe-title {
    margin: 0.1rem 0 0.3rem 0;
    color: var(--text-primary);
}

.recipe-meta {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.recipe-macros {
    margin: 0.25rem 0 0 0;
    color: var(--text-primary);
    font-size: 0.8rem;
}

.recipe-actions {
    margin-top: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
}

.recipe-planner {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
}

.planner-label {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    color: var(--text-secondary);
}

.recipe-plan-date {
    margin-left: 0.25rem;
    padding: 0.4rem 0.6rem;
    font-size: 0.85rem;
    border: 1px solid var(--border);
    border-radius: 6px;
}

.recipe-details {
    margin-top: 0.75rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem;
    background: #f9fafb;
    transition: all 0.2s ease;
}

.recipe-details[open] {
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.recipe-details summary {
    cursor: pointer;
    font-weight: 600;
    color: var(--primary);
    list-style: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.recipe-details summary::-webkit-details-marker {
    display: none;
}

.recipe-details summary::before {
    content: '‚ñ∂';
    font-size: 0.7rem;
    transition: transform 0.2s ease;
}

.recipe-details[open] summary::before {
    transform: rotate(90deg);
}

.recipe-details summary:hover {
    color: var(--primary-dark);
}

.ingredients-list {
    margin: 0.5rem 0 0 1rem;
    font-size: 0.9rem;
}

.instructions-content {
    margin: 0.5rem 0 0 0.5rem;
    font-size: 0.9rem;
}

.instructions-text {
    margin: 0;
    font-size: 0.9rem;
    color: #444;
}

.empty-instructions {
    color: #777;
    font-size: 0.9rem;
    margin: 0;
}

.empty-list {
    color: #777;
}

.recipe-link {
    margin-top: 0.4rem;
    font-size: 0.85rem;
}

.recipe-link a {
    color: var(--primary);
    text-decoration: none;
}

.recipe-link a:hover {
    text-decoration: underline;
}

.food-detail-card {
    max-width: 800px;
    margin: 1rem auto;
}

.food-header {
    background: #fff5f0;
    border: 1px solid #ffd4c0;
    border-radius: 8px;
    padding: 1rem;
}

.serving-info {
    color: var(--text-secondary);
    margin-top: 0.25rem;
    font-size: 0.9rem;
}

.nutrients-heading {
    margin-top: 1rem;
    color: var(--text-primary);
}

.nutrients-list {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0 1rem 0;
}

.nutrient-row {
    display: flex;
    justify-content: space-between;
    border-bottom: 1px dashed #ddd;
    padding: 0.5rem 0;
}

.fridge-inventory {
    max-width: 800px;
    margin: 2rem auto 3rem auto;
}

.fridge-description {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-top: 0.25rem;
}

.fridge-list {
    list-style: none;
    padding: 0;
    margin: 1rem 0;
}

.fridge-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px dashed #ddd;
    padding: 0.6rem 0;
}

.fridge-item-info {
    display: flex;
    flex-direction: column;
}

.fridge-item-title {
    font-weight: 500;
    color: var(--text-primary);
}

.fridge-item-macros {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

.fridge-empty {
    color: #777;
}

.info-text {
    max-width: 800px;
    margin: 1rem auto;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, #fff5f0 0%, #ffe8dc 100%);
    border: 2px solid var(--primary-light);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 0.95rem;
    box-shadow: 0 2px 8px rgba(255, 107, 53, 0.1);
}

.error-box {
    white-space: pre-wrap;
    background: #fff3f3;
    border: 2px solid #f3b5b5;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    max-width: 800px;
    margin: 1rem auto;
    box-shadow: 0 2px 8px rgba(229, 62, 62, 0.1);
}

.budget-filter-wrapper {
    max-width: 800px;
    margin: 0.5rem auto 0 auto;
}

.budget-filter {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.budget-label {
    color: var(--text-primary);
}

.budget-select {
    padding: 0.4rem 0.7rem;
    border-radius: 6px;
    border: 1px solid var(--border);
    font-size: 0.9rem;
    background: white;
}

@media (max-width: 768px) {
    .top-bar {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
    }

    .page-title {
        position: static;
        left: auto;
    }
    
    .right-side-lks {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        position: static;
        right: auto;
    }
    
    .recipe-content {
        flex-direction: column;
    }
    
    .recipe-image {
        width: 100%;
        height: 200px;
    }
    
    .omnisearchinput {
        font-size: 16px;
    }

    .omni-banner-fullscreen .banner-title {
        font-size: 2.5rem;
    }

    .omni-banner-fullscreen .banner-tagline {
        font-size: 1rem;
        padding: 0 1rem;
        text-align: center;
    }

    .myfridge-left, .mealplanner-right {
        position: static;
        margin: 1rem auto;
        text-align: center;
    }
    
    .myfridgebutton, .mealplannerbutton {
        display: inline-block;
    }
}

body {
    overflow-x: hidden;
    max-width: 100vw;
}

* {
    box-sizing: border-box;
}
    </style>
</div>
</Layout>