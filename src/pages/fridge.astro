---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import '../styles/style.css';

/** ---------- helpers ---------- */
function fmtErr(prefix: string, e: unknown) {
    const base = e as any;
    return [
        prefix,
        base?.message && `message: ${base.message}`,
        base?.code && `code: ${base.code}`,
        base?.details && `details: ${base.details}`,
        base?.hint && `hint: ${base.hint}`,
        base?.name && `name: ${base.name}`,
        base?.status && `status: ${base.status}`,
    ].filter(Boolean).join(' | ');
}

type FoodDetails = any;
type NutrEntry = { value: number; unit: string };

// Which tab are we on?
const mode = Astro.url.searchParams.get('mode') === 'recipes' ? 'recipes' : 'ingredients';

// Shared search query
const query = (Astro.url.searchParams.get('q') || '').trim() || '';

// Budget filter (recipes only)
const budgetParam = (Astro.url.searchParams.get('budget') || '').trim();
const budget = budgetParam ? Number(budgetParam) : null;

const FDC_KEY = import.meta.env.FDC_API_KEY;
if (!FDC_KEY) throw new Error('Missing FDC_API_KEY (set in env)');

// USDA state
let food: FoodDetails | null = null;
let foodError: { message: string } | null = null;

// Spoonacular state
const SPOON_KEY = import.meta.env.SPOONACULAR || '';
let recipes: any[] = [];
let recipeError: { message: string } | null = null;

/** ---------- USDA INGREDIENT LOOKUP ---------- */
if (mode === 'ingredients' && query) {
    try {
        const sUrl = new URL('https://api.nal.usda.gov/fdc/v1/foods/search');
        sUrl.searchParams.set('api_key', FDC_KEY);
        sUrl.searchParams.set('query', query);
        sUrl.searchParams.set('pageSize', '1');
        sUrl.searchParams.set('dataType', 'Branded,SR Legacy,Survey (FNDDS)');

        const sRes = await fetch(sUrl.toString());
        const sTxt = await sRes.text();
        if (!sRes.ok) throw new Error(`Search HTTP ${sRes.status} ${sRes.statusText} | ${sTxt.slice(0,200)}`);

        const sJson = JSON.parse(sTxt);
        const top = sJson?.foods?.[0];
        if (!top?.fdcId) throw new Error(`No results for "${query}"`);

        const dUrl = new URL(`https://api.nal.usda.gov/fdc/v1/food/${top.fdcId}`);
        dUrl.searchParams.set('api_key', FDC_KEY);

        const dRes = await fetch(dUrl.toString());
        const dTxt = await dRes.text();
        if (!dRes.ok) throw new Error(`Details HTTP ${dRes.status} ${dRes.statusText} | ${dTxt.slice(0,200)}`);

        food = JSON.parse(dTxt);
    } catch (e) {
        console.error('[fdc][fridge]', e);
        foodError = { message: fmtErr('USDA error', e) };
    }
}

/** ---------- SPOONACULAR RECIPE SEARCH ---------- */
if (mode === 'recipes' && query) {
    try {
        if (!SPOON_KEY) {
            throw new Error('Missing SPOONACULAR env var');
        }

        const rUrl = new URL('https://api.spoonacular.com/recipes/complexSearch');
        rUrl.searchParams.set('apiKey', SPOON_KEY);
        rUrl.searchParams.set('query', query);
        rUrl.searchParams.set('addRecipeInformation', 'true');
        rUrl.searchParams.set('number', '8');

        const rRes = await fetch(rUrl.toString());
        const rTxt = await rRes.text();
        if (!rRes.ok) throw new Error(`Spoonacular HTTP ${rRes.status} ${rRes.statusText} | ${rTxt.slice(0,200)}`);

        const rJson = JSON.parse(rTxt);
        recipes = rJson?.results ?? [];
    } catch (e) {
        console.error('[spoonacular][fridge]', e);
        recipeError = { message: fmtErr('Recipe error', e) };
    }
}

/** normalize nutrients from both shapes */
function buildMap(fd: any) {
    const map = new Map<string, NutrEntry>();

    // A) generic list
    for (const n of (fd?.foodNutrients ?? [])) {
        const name = n.nutrientName ?? n.nutrient?.name;
        const unit = n.unitName ?? n.nutrient?.unitName ?? '';
        const val  = n.value ?? n.amount;
        if (name != null && val != null) {
            map.set(String(name).toLowerCase(), { value: Number(val), unit });
        }
    }

    // B) labelNutrients (per serving)
    const ln = fd?.labelNutrients || {};
    const addLN = (key: string, pretty: string, unit: string) => {
        if (ln[key]?.value != null) map.set(pretty.toLowerCase(), { value: Number(ln[key].value), unit });
    };
    addLN('calories',      'Energy',                       'kcal');
    addLN('fat',           'Total lipid (fat)',            'g');
    addLN('carbohydrates', 'Carbohydrate, by difference',  'g');
    addLN('sugars',        'Sugars, total including NLEA', 'g');
    addLN('protein',       'Protein',                      'g');

    return map;
}

const NMAP = food ? buildMap(food) : new Map();

function pickAny(names: string[]): { value: number | null; unit: string } {
    for (const name of names) {
        const hit = NMAP.get(name.toLowerCase());
        if (hit) return hit;
    }
    return { value: null, unit: '' };
}
function fmt(val: number | null, unit: string) {
    if (val == null) return '‚Äî';
    const fixed = /kcal/i.test(unit) ? val.toFixed(0) : val.toFixed(1);
    return `${fixed} ${unit}`;
}

// per serving
const S_ENERGY = food ? pickAny(['Energy', 'Energy (Atwater General Factors)']) : { value: null, unit: '' };
const S_PRO    = food ? pickAny(['Protein']) : { value: null, unit: '' };
const S_FAT    = food ? pickAny(['Total lipid (fat)', 'Total Fat']) : { value: null, unit: '' };
const S_CARB   = food ? pickAny(['Carbohydrate, by difference', 'Total Carbohydrate']) : { value: null, unit: '' };
const S_SUGAR  = food ? pickAny(['Sugars, total including NLEA', 'Sugars, total']) : { value: null, unit: '' };

// budget-filtered recipes
const filteredRecipes =
    budget && !Number.isNaN(budget)
        ? recipes.filter((r: any) =>
            typeof r.pricePerServing === 'number' &&
            r.pricePerServing / 100 <= budget
        )
        : recipes;
---

<Layout title="Add ingredients to your fridge ‚Ä¢ OmniCookBook">
    <!-- top bar -->
    <nav class="top-bar">
        <a href="/" class="page-title">
            <img src="/img/omnilogo.png" alt="logo" height="32" width="32" />
            OmniCookBook
            <img src="/img/omnilogo.png" alt="logo" height="32" width="32" style="transform: scaleX(-1);" />
        </a>

        <div class="right-side-lks">
            <a href="/" class="home">Home</a>
            <a href="/about" class="about">About</a>
            <a href="/contact-us" class="contact-us">Contact us</a>
        </div>
    </nav>

    <!-- left/right buttons -->
    <div class="myfridge-left">
        <a href="/fridge">
            <button class="myfridgebutton">My Fridge</button>
        </a>
    </div>
    <div class="mealplanner-right">
        <a href="/test">
            <button class="mealplannerbutton">Meal Planner</button>
        </a>
    </div>

    <!-- TABS -->
    <section class="fridge-tabs-wrapper">
        <div class="fridge-tabs-bar">
            <a
                href="/fridge?mode=ingredients"
                class={`fridge-tab ${mode === 'ingredients' ? 'active' : ''}`}
            >
                Ingredients (USDA)
            </a>
            <a
                href="/fridge?mode=recipes"
                class={`fridge-tab ${mode === 'recipes' ? 'active' : ''}`}
            >
                Recipes (Spoonacular)
            </a>
        </div>
    </section>

    <!-- INGREDIENT MODE -->
    {mode === 'ingredients' && (
        <>
            <p class="prompt-index">Add ingredients to your fridge</p>
            <form class="omnisearchbox" method="get" action="/fridge">
                <input type="hidden" name="mode" value="ingredients" />
                <input
                    class="omnisearchinput"
                    name="q"
                    value={query}
                    placeholder="Search for an ingredient (e.g. milk, chicken breast)"
                />
                <button class="omnisearchbutton" aria-label="Search">üîç</button>
            </form>

            {foodError && (
                <pre style="white-space:pre-wrap;background:#fff3f3;border:1px solid #f3b5b5;padding:.75rem;border-radius:.5rem;max-width:800px;margin:1rem auto;">
{foodError.message}
                </pre>
            )}

            {!foodError && !query && (
                <p style="max-width:800px;margin:1rem auto;color:#666;font-size:.95rem;">
                    Start by searching for an ingredient above. When you find the correct item, click
                    <strong> ‚ÄúAdd to My Fridge‚Äù</strong> to save it locally.
                </p>
            )}

            {!foodError && query && !food && (
                <p style="max-width:800px;margin:1rem auto;color:#666;font-size:.95rem;">
                    No ingredient results found for <strong>{query}</strong>.
                </p>
            )}

            {!foodError && food && (
                <section
                    id="current-food"
                    style="max-width:800px;margin:1rem auto;"
                    data-name={food.description || query}
                    data-brand={food.brandOwner || ''}
                    data-kind="ingredient"
                >
                    <div style="background:#f7fbff;border:1px solid #dde8f6;border-radius:.5rem;padding:1rem;">
                        <strong>{food.description || query}</strong>
                        {food.brandOwner && <> ‚Äî <em>{food.brandOwner}</em></>}
                        <div style="color:#555;margin-top:.25rem;">
                            Serving: {food.servingSize ? `${food.servingSize} ${food.servingSizeUnit || ''}` : 'n/a'}
                        </div>
                    </div>

                    <h3 style="margin-top:1rem;">Per serving</h3>
                    <ul style="list-style:none;padding:0;margin:.5rem 0 1rem 0;">
                        <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                            <span>Energy</span><span>{fmt(S_ENERGY.value, S_ENERGY.unit)}</span>
                        </li>
                        <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                            <span>Protein</span><span>{fmt(S_PRO.value, S_PRO.unit)}</span>
                        </li>
                        <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                            <span>Total fat</span><span>{fmt(S_FAT.value, S_FAT.unit)}</span>
                        </li>
                        <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                            <span>Carbohydrate</span><span>{fmt(S_CARB.value, S_CARB.unit)}</span>
                        </li>
                        <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                            <span>Sugars</span><span>{fmt(S_SUGAR.value, S_SUGAR.unit)}</span>
                        </li>
                    </ul>

                    <button
                        id="add-to-fridge"
                        type="button"
                        style="margin-top:.5rem;padding:.5rem 1rem;border-radius:.5rem;border:1px solid #4caf50;background:#4caf50;color:white;cursor:pointer;"
                    >
                        ‚ûï Add Ingredient to My Fridge
                    </button>
                </section>
            )}
        </>
    )}

    <!-- RECIPE MODE -->
    {mode === 'recipes' && (
        <>
            <p class="prompt-index">Find recipes to cook</p>
            <form class="omnisearchbox" method="get" action="/fridge">
                <input type="hidden" name="mode" value="recipes" />
                <input
                    class="omnisearchinput"
                    name="q"
                    value={query}
                    placeholder="Search for recipes (e.g. chicken alfredo, stir fry)"
                />
                <button class="omnisearchbutton" aria-label="Search">üîç</button>
            </form>

            {/* BUDGET DROPDOWN UNDER SEARCH BAR */}
            <div style="max-width:800px;margin:0.5rem auto 0 auto;">
                <form
                    class="budget-filter"
                    method="get"
                    action="/fridge"
                    style="display:flex;align-items:center;gap:.5rem;font-size:.9rem;"
                >
                    <input type="hidden" name="mode" value="recipes" />
                    <input type="hidden" name="q" value={query} />
                    <label for="budget-select" style="color:#444;">
                        Budget per recipe:
                    </label>
                    <select
                        id="budget-select"
                        name="budget"
                        onchange="this.form.submit()"
                        style="padding:.25rem .5rem;border-radius:.35rem;border:1px solid #ccc;font-size:.9rem;"
                    >
                        <option value="" selected={!budgetParam}>No budget filter</option>
                        <option value="5" selected={budget === 5}>Under $5</option>
                        <option value="10" selected={budget === 10}>Under $10</option>
                        <option value="15" selected={budget === 15}>Under $15</option>
                        <option value="20" selected={budget === 20}>Under $20</option>
                    </select>
                </form>
            </div>

            {recipeError && (
                <pre style="white-space:pre-wrap;background:#fff3f3;border:1px solid #f3b5b5;padding:.75rem;border-radius:.5rem;max-width:800px;margin:1rem auto;">
{recipeError.message}
                </pre>
            )}

            {!recipeError && !query && (
                <p style="max-width:800px;margin:1rem auto;color:#666;font-size:.95rem;">
                    Search for recipes powered by Spoonacular. You can add recipes to your fridge and optionally
                    schedule them directly into your meal planner.
                </p>
            )}

            {/* No recipes at all for this query */}
            {!recipeError && query && recipes.length === 0 && (
                <p style="max-width:800px;margin:1rem auto;color:#666;font-size:.95rem;">
                    No recipes found for <strong>{query}</strong>.
                </p>
            )}

            {/* Recipes exist but none are under this budget */}
            {!recipeError && query && recipes.length > 0 && filteredRecipes.length === 0 && budget && (
                <p style="max-width:800px;margin:1rem auto;color:#666;font-size:.95rem;">
                    We found recipes for <strong>{query}</strong>, but none are under your budget of
                    {' '}${budget.toFixed(0)} per recipe. Try increasing your budget or clearing the filter.
                </p>
            )}

            {!recipeError && filteredRecipes.length > 0 && (
                <section style="max-width:800px;margin:1.5rem auto 1rem auto;">
                    {filteredRecipes.map((r) => (
                        <article
                            class="recipe-card"
                            data-recipe-id={r.id}
                            data-recipe-title={r.title}
                            data-kind="recipe"
                            style="border:1px solid #dde8f6;border-radius:.75rem;padding:1rem;margin-bottom:1rem;background:#f8fbff;"
                        >
                            <div style="display:flex;gap:1rem;">
                                {r.image && (
                                    <img
                                        src={r.image}
                                        alt={r.title}
                                        style="width:96px;height:96px;object-fit:cover;border-radius:.5rem;border:1px solid #ddd;"
                                        loading="lazy"
                                    />
                                )}
                                <div style="flex:1;">
                                    <h3 style="margin:.1rem 0 .3rem 0;">{r.title}</h3>
                                    <p style="margin:0;color:#555;font-size:.9rem;">
                                        {r.readyInMinutes && <>‚è± {r.readyInMinutes} min&nbsp;&nbsp;</>}
                                        {r.servings && <>üçΩ Serves {r.servings}</>}
                                        {typeof r.pricePerServing === 'number' && (
                                            <>
                                                &nbsp;&nbsp;üí≤
                                                {(r.pricePerServing / 100).toFixed(2)} per serving
                                            </>
                                        )}
                                    </p>

                                    <details style="margin-top:.4rem;">
                                        <summary style="cursor:pointer;font-size:.9rem;">Ingredients</summary>
                                        <ul style="margin:.3rem 0 0 1rem;font-size:.9rem;">
                                            {(r.extendedIngredients ?? []).map((ing: any) => (
                                                <li>{ing.original}</li>
                                            ))}
                                            {(!r.extendedIngredients || r.extendedIngredients.length === 0) && (
                                                <li style="color:#777;">No ingredient list available.</li>
                                            )}
                                        </ul>
                                    </details>

                                    <details style="margin-top:.4rem;">
                                        <summary style="cursor:pointer;font-size:.9rem;">Instructions</summary>
                                        <ol style="margin:.3rem 0 0 1.2rem;font-size:.9rem;">
                                            {(r.analyzedInstructions?.[0]?.steps ?? []).map((st: any) => (
                                                <li>{st.step}</li>
                                            ))}
                                            {(!r.analyzedInstructions || !r.analyzedInstructions[0]?.steps?.length) && (
                                                <li style="color:#777;">No detailed instructions available.</li>
                                            )}
                                        </ol>
                                    </details>
                                </div>
                            </div>

                            <div style="margin-top:.6rem;display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;">
                                <button
                                    type="button"
                                    class="recipe-add-fridge"
                                    style="padding:.4rem .9rem;border-radius:.5rem;border:1px solid #4caf50;background:#4caf50;color:white;cursor:pointer;font-size:.85rem;"
                                >
                                    ‚ûï Add Recipe to My Fridge
                                </button>

                                <div style="display:flex;align-items:center;gap:.25rem;font-size:.85rem;">
                                    <label>
                                        Plan for:
                                        <input
                                            type="date"
                                            class="recipe-plan-date"
                                            data-recipe-id={r.id}
                                            style="margin-left:.25rem;padding:.15rem .25rem;font-size:.85rem;"
                                        />
                                    </label>
                                    <button
                                        type="button"
                                        class="recipe-add-plan"
                                        data-recipe-id={r.id}
                                        style="padding:.3rem .8rem;border-radius:.5rem;border:1px solid #1976d2;background:#1976d2;color:white;cursor:pointer;font-size:.8rem;"
                                    >
                                        ‚ûï Add to Meal Planner
                                    </button>
                                </div>
                            </div>
                        </article>
                    ))}
                </section>
            )}
        </>
    )}

    <!-- fridge inventory -->
    <section style="max-width:800px;margin:2rem auto 3rem auto;">
        <h2>My Fridge</h2>
        <p style="color:#666;font-size:.9rem;margin-top:.25rem;">
            Items are stored in your browser only (localStorage). Clearing site data will reset this list.
        </p>
        <ul id="fridge-list" style="list-style:none;padding:0;margin:1rem 0;"></ul>
        <button
            id="clear-fridge"
            type="button"
            style="display:none;margin-top:.5rem;padding:.4rem .9rem;border-radius:.4rem;border:1px solid #c62828;background:#c62828;color:white;cursor:pointer;font-size:.85rem;"
        >
            üóë Clear My Fridge
        </button>
    </section>

    <script type="module">
        const STORAGE_KEY = 'omni-fridge-items';
        const MP_KEY = 'omni-mealplan-monthly';

        function loadFridge() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch {
                return [];
            }
        }

        function saveFridge(items) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
        }

        function renderFridge() {
            const listEl = document.getElementById('fridge-list');
            const clearBtn = document.getElementById('clear-fridge');
            if (!listEl) return;

            const items = loadFridge();
            listEl.innerHTML = '';

            if (!items.length) {
                listEl.innerHTML = '<li style="color:#777;">Your fridge is empty. Add something above!</li>';
                if (clearBtn) clearBtn.style.display = 'none';
                return;
            }

            for (const item of items) {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.borderBottom = '1px dashed #ddd';
                li.style.padding = '.4rem 0';

                const left = document.createElement('span');
                const isRecipe = item.kind === 'recipe';
                const tag = isRecipe ? 'üìñ ' : 'üß∫ ';
                left.textContent = tag + item.name + (item.brand ? ` ‚Äî ${item.brand}` : '');

                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remove';
                removeBtn.style.fontSize = '.8rem';
                removeBtn.style.borderRadius = '.4rem';
                removeBtn.style.border = '1px solid #999';
                removeBtn.style.background = '#f5f5f5';
                removeBtn.style.cursor = 'pointer';

                removeBtn.addEventListener('click', () => {
                    const updated = loadFridge().filter((x) => x.id !== item.id);
                    saveFridge(updated);
                    renderFridge();
                });

                li.appendChild(left);
                li.appendChild(removeBtn);
                listEl.appendChild(li);
            }

            if (clearBtn) clearBtn.style.display = 'inline-block';
        }

        // meal planner helpers (monthly)
        function loadPlan() {
            try {
                const raw = localStorage.getItem(MP_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch {
                return {};
            }
        }

        function savePlan(p) {
            localStorage.setItem(MP_KEY, JSON.stringify(p));
        }

        document.addEventListener('DOMContentLoaded', () => {
            // initial fridge render
            renderFridge();

            const addIngredientBtn = document.getElementById('add-to-fridge');
            const currentFood = document.getElementById('current-food');
            const clearBtn = document.getElementById('clear-fridge');

            // add ingredient (USDA) to fridge
            if (addIngredientBtn && currentFood) {
                addIngredientBtn.addEventListener('click', () => {
                    const name = currentFood.dataset.name || 'Unknown item';
                    const brand = currentFood.dataset.brand || '';
                    const kind = currentFood.dataset.kind || 'ingredient';
                    const id = kind + '|' + name + '|' + brand;

                    const items = loadFridge();
                    if (!items.find((x) => x.id === id)) {
                        items.push({ id, name, brand, kind });
                        saveFridge(items);
                        renderFridge();
                    } else {
                        alert('This item is already in your fridge.');
                    }
                });
            }

            // clear fridge
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (confirm('Clear all items from your fridge?')) {
                        saveFridge([]);
                        renderFridge();
                    }
                });
            }

            // add recipes to fridge
            document.querySelectorAll('.recipe-add-fridge').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const card = btn.closest('.recipe-card');
                    if (!card) return;
                    const name = card.dataset.recipeTitle || 'Unknown recipe';
                    const recipeId = card.dataset.recipeId || '';
                    const kind = card.dataset.kind || 'recipe';
                    const id = 'recipe|' + recipeId;

                    const items = loadFridge();
                    if (!items.find((x) => x.id === id)) {
                        items.push({ id, name, brand: '', kind });
                        saveFridge(items);
                        renderFridge();
                    } else {
                        alert('This recipe is already in your fridge.');
                    }
                });
            });

            // add recipes directly to meal planner (monthly)
            document.querySelectorAll('.recipe-add-plan').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const recipeId = btn.dataset.recipeId;
                    const card = btn.closest('.recipe-card');
                    if (!card || !recipeId) return;

                    const name = card.dataset.recipeTitle || 'Unknown recipe';
                    const dateInput = card.querySelector('.recipe-plan-date');
                    const dateVal = dateInput?.value;

                    if (!dateVal) {
                        alert('Please choose a date first.');
                        return;
                    }

                    // dateVal is YYYY-MM-DD, convert to key used by monthly planner
                    const [y, m, d] = dateVal.split('-');
                    const key = `${Number(y)}-${Number(m)}-${Number(d)}`;

                    const plan = loadPlan();
                    plan[key] = plan[key] || [];

                    const id = 'recipe|' + recipeId;
                    if (!plan[key].find((x) => x.id === id)) {
                        plan[key].push({ id, name, brand: 'Recipe' });
                        savePlan(plan);
                        alert('Recipe added to your meal planner for ' + dateVal);
                    } else {
                        alert('This recipe is already on your plan for that day.');
                    }
                });
            });
        });
    </script>

    <style>
        .fridge-tabs-wrapper {
            max-width: 800px;
            margin: 2.5rem auto 1.75rem auto; /* nice gap under page <h1> */
        }
        .fridge-tabs-bar {
            display: flex;
            gap: 1rem;
            background: #ffffff;
            padding: 1rem 1.2rem;
            border-radius: 0.75rem;
            border: 1px solid #ccc;
            box-shadow: 0 2px 6px rgba(0,0,0,0.10);
        }
        .fridge-tab {
            padding: 0.6rem 1.1rem;
            border-radius: 0.5rem;
            background: #ededed;
            color: #333;
            font-weight: 500;
            text-decoration: none;
            font-size: 0.95rem;
        }
        .fridge-tab.active {
            background: #4caf50;
            color: #ffffff;
            font-weight: 700;
        }
    </style>
</Layout>
