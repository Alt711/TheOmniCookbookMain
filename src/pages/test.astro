---
export const prerender = false;

import Layout from '../layouts/Layout.astro'
import '../styles/style.css'

// ---------- helpers ----------
function fmtErr(prefix: string, e: unknown) {
    const b = e as any;
    return [
        prefix,
        b?.message && `message: ${b.message}`,
        b?.code && `code: ${b.code}`,
        b?.details && `details: ${b.details}`,
        b?.hint && `hint: ${b.hint}`,
        b?.name && `name: ${b.name}`,
        b?.status && `status: ${b.status}`,
    ].filter(Boolean).join(' | ');
}

type Food = any;
type Nutr = { value: number, unit: string };

const KEY = import.meta.env.FDC_API_KEY;
if (!KEY) throw new Error("Missing FDC_API_KEY");

const query = (Astro.url.searchParams.get("q") || "").trim() || "";

let food: Food | null = null;
let error: { message: string } | null = null;

//try and get data
if (query) {
    try {
        const sUrl = new URL("https://api.nal.usda.gov/fdc/v1/foods/search");
        sUrl.searchParams.set("api_key", KEY);
        sUrl.searchParams.set("query", query);
        sUrl.searchParams.set("pageSize", "1");
        sUrl.searchParams.set("dataType", "Branded,SR Legacy,Survey (FNDDS)");

        const sRes = await fetch(sUrl.toString());
        const sTxt = await sRes.text();
        if (!sRes.ok) throw new Error(`Search HTTP ${sRes.status} | ${sTxt}`);
        const sJson = JSON.parse(sTxt);
        const top = sJson?.foods?.[0];
        if (!top?.fdcId) throw new Error(`No results for '${query}'`);

        const dUrl = new URL(`https://api.nal.usda.gov/fdc/v1/food/${top.fdcId}`);
        dUrl.searchParams.set("api_key", KEY);

        const dRes = await fetch(dUrl.toString());
        const dTxt = await dRes.text();
        if (!dRes.ok) throw new Error(`Details HTTP ${dRes.status} | ${dTxt}`);

        food = JSON.parse(dTxt);
    } catch (e) {
        error = { message: fmtErr("Caught", e) };
    }
}

//data formating
function buildMap(fd: any) {
    const map = new Map<string, Nutr>();

    for (const n of (fd?.foodNutrients ?? [])) {
        const nm = n.nutrientName ?? n.nutrient?.name;
        const unit = n.unitName ?? n.nutrient?.unitName ?? "";
        const val = n.value ?? n.amount;
        if (nm != null && val != null)
            map.set(String(nm).toLowerCase(), { value: Number(val), unit });
    }

    const ln = fd?.labelNutrients || {};
    const add = (key: string, pretty: string, unit: string) => {
        if (ln[key]?.value != null)
            map.set(pretty.toLowerCase(), { value: ln[key].value, unit });
    };

    add("calories", "Energy", "kcal");
    add("fat", "Total lipid (fat)", "g");
    add("carbohydrates", "Carbohydrate, by difference", "g");
    add("sugars", "Sugars, total", "g");
    add("protein", "Protein", "g");

    return map;
}

const NMAP = food ? buildMap(food) : new Map();

function pickAny(names: string[]) {
    for (const n of names) {
        const hit = NMAP.get(n.toLowerCase());
        if (hit) return hit;
    }
    return { value: null as number | null, unit: "" };
}
function fmt(v: number|null, unit: string) {
    if (v == null) return "â€”";
    const fixed = /kcal/i.test(unit) ? v.toFixed(0) : v.toFixed(1);
    return `${fixed} ${unit}`;
}

const S_ENERGY = food ? pickAny(["Energy"]) : { value:null, unit:""};
const S_PRO    = food ? pickAny(["Protein"]) : { value:null, unit:""};
const S_FAT    = food ? pickAny(["Total lipid (fat)"]) : { value:null, unit:""};
const S_CARB   = food ? pickAny(["Carbohydrate, by difference"]) : { value:null, unit:""};
const S_SUGAR  = food ? pickAny(["Sugars, total"]) : { value:null, unit:""};
---

<Layout title="Meal Planner â€¢ OmniCookBook">

    <!-- NAVBAR -->
    <nav class="top-bar">
        <a href="/" class="page-title">
            <img src="/img/omnilogo.png" width="32" height="32"/>
            OmniCookBook
            <img src="/img/omnilogo.png" width="32" height="32" style="transform:scaleX(-1)"/>
        </a>

        <div class="right-side-lks">
            <a href="/" class="home">Home</a>
            <a href="/about" class="about">About</a>
            <a href="/contact-us" class="contact-us">Contact us</a>
        </div>
    </nav>

    <!-- Buttons -->
    <div class="myfridge-left">
        <a href="/fridge"><button class="myfridgebutton">My Fridge</button></a>
    </div>
    <div class="mealplanner-right">
        <a href="/test"><button class="mealplannerbutton">Meal Planner</button></a>
    </div>



    {error && (
        <pre style="white-space:pre-wrap;background:#fff3f3;border:1px solid #f3b5b5;padding:.75rem;border-radius:.5rem;max-width:800px;margin:1rem auto;">
{error.message}
        </pre>
    )}

    {!error && query && food && (
        <section
            id="current-food"
            style="max-width:800px;margin:1rem auto;"
            data-name={food.description || query}
            data-brand={food.brandOwner || ''}
            data-energy={S_ENERGY.value ?? ''}
            data-protein={S_PRO.value ?? ''}
            data-fat={S_FAT.value ?? ''}
            data-carbs={S_CARB.value ?? ''}
            data-sugar={S_SUGAR.value ?? ''}>

            <div style="background:#f7fbff;border:1px solid #dde8f6;padding:1rem;border-radius:.5rem;">
                <strong>{food.description || query}</strong>
                {food.brandOwner && <> â€” <em>{food.brandOwner}</em></>}
            </div>

            <h3 style="margin-top:1rem;">Per serving</h3>
            <ul style="list-style:none;padding:0;margin:.5rem 0 1rem 0;">
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Energy</span><span>{fmt(S_ENERGY.value, S_ENERGY.unit)}</span>
                </li>
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Protein</span><span>{fmt(S_PRO.value, S_PRO.unit)}</span>
                </li>
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Total Fat</span><span>{fmt(S_FAT.value, S_FAT.unit)}</span>
                </li>
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Carbs</span><span>{fmt(S_CARB.value, S_CARB.unit)}</span>
                </li>
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Sugar</span><span>{fmt(S_SUGAR.value, S_SUGAR.unit)}</span>
                </li>
            </ul>

        </section>
    )}

    <!-- MONTHLY MEAL PLAN + MACRO SIDEBAR -->
    <section style="max-width:1150px;margin:2rem auto 3rem auto;">
        <h2>Monthly Meal Planner</h2>
        <p style="color:#666;font-size:.9rem;">Stored in your browser (localStorage)</p>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem;">
            <button id="prev-month" style="padding:.4rem .8rem;border-radius:.4rem;">â—€</button>
            <h3 id="month-title" style="margin:0;"></h3>
            <button id="next-month" style="padding:.4rem .8rem;border-radius:.4rem;">â–¶</button>
        </div>

        <div
            style="
                display:flex;
                align-items:flex-start;
                gap:2rem;
                margin-top:1.5rem;
                flex-wrap:nowrap;
                overflow-x:auto;
            "
        >
            <!-- Calendar column with scroll -->
            <div
                id="calendar-column"
                style="
                    flex:1;
                    min-width:0;
                    max-height:80vh;
                    overflow-y:auto;
                    padding-right:.75rem;
                "
            >
                <div
                    id="calendar-grid"
                    style="
                        display:grid;
                        grid-template-columns:repeat(7,1fr);
                        gap:.75rem;
                    "
                ></div>

                <button
                    id="clear-plan"
                    style="
                        display:none;
                        margin-top:1.5rem;
                        padding:.5rem 1rem;
                        border-radius:.4rem;
                        border:1px solid #c62828;
                        background:#c62828;
                        color:white;
                        cursor:pointer;
                    "
                >
                    ðŸ—‘ Clear Entire Month
                </button>
            </div>

            <!-- Macro sidebar with its own scroll -->
            <aside
                id="macro-sidebar"
                style="
                    width:350px;
                    max-width:100%;
                    background:#ffffff;
                    border:1px solid #ddd;
                    border-radius:.75rem;
                    padding:1rem;
                    box-shadow:0 2px 6px rgba(0,0,0,0.06);
                    position:sticky;
                    top:6rem;
                    overflow-y:auto;
                    max-height:80vh;
                "
            >
                <h3 style="margin:0 0 .35rem 0;">Macro Overview</h3>
                <p style="color:#666;font-size:.8rem;margin:0 0 .75rem 0;">
                    Based on items with tracked macros only.
                </p>

                <div id="sidebar-selected-day" style="font-size:.9rem;"></div>

                <hr style="margin:1rem 0;border:none;border-top:1px solid #eee;" />

                <div id="sidebar-week-summary" style="font-size:.9rem;"></div>

                <hr style="margin:1rem 0;border:none;border-top:1px solid #eee;" />

                <div id="sidebar-month-summary" style="font-size:.9rem;"></div>
            </aside>
        </div>
    </section>

    <script type="module">
        const KEY = "omni-mealplan-monthly";

        function loadPlan() {
            const raw = localStorage.getItem(KEY);
            return raw ? JSON.parse(raw) : {};
        }
        function savePlan(p) {
            localStorage.setItem(KEY, JSON.stringify(p));
        }

        const today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        // which date is currently selected in the calendar (for sidebar)
        let selectedDateKey = null;

        const monthNames = [
            "January","February","March","April","May","June",
            "July","August","September","October","November","December"
        ];

        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }

        function emptyTotals() {
            return {
                calories: 0,
                protein: 0,
                fat: 0,
                carbs: 0,
                sugars: 0
            };
        }

        function addTotals(target, src) {
            target.calories += src.calories || 0;
            target.protein  += src.protein  || 0;
            target.fat      += src.fat      || 0;
            target.carbs    += src.carbs    || 0;
            target.sugars   += src.sugars   || 0;
        }

        function formatTotals(t) {
            const kcal = t.calories.toFixed(0);
            const p    = t.protein.toFixed(1);
            const f    = t.fat.toFixed(1);
            const c    = t.carbs.toFixed(1);
            const s    = t.sugars.toFixed(1);
            return `Calories: ${kcal} kcal Â· Protein: ${p} g Â· Fat: ${f} g Â· Carbs: ${c} g Â· Sugar: ${s} g`;
        }

        function updateSidebar(selectedKey, dayTotalsMap, weekTotals, monthTotals, days, firstDow) {
            const selEl   = document.getElementById("sidebar-selected-day");
            const weekEl  = document.getElementById("sidebar-week-summary");
            const monthEl = document.getElementById("sidebar-month-summary");
            if (!selEl || !weekEl || !monthEl) return;

            // Selected day panel
            if (!selectedKey) {
                selEl.innerHTML = `
                    <p style="color:#666;font-size:.85rem;margin:0;">
                        Click a day on the calendar to see its macros.
                    </p>
                `;
                weekEl.innerHTML = `
                    <p style="color:#666;font-size:.85rem;margin:0;">
                        Once a day is selected, its week's totals will appear here.
                    </p>
                `;
            } else {
                const dt = dayTotalsMap[selectedKey] || emptyTotals();
                const parts = selectedKey.split("-");
                const y = Number(parts[0]);
                const m = Number(parts[1]);
                const d = Number(parts[2]);
                const label = `${monthNames[m - 1]} ${d}, ${y}`;

                selEl.innerHTML = `
                    <h3 style="margin:0 0 .35rem 0;font-size:1rem;">Selected day</h3>
                    <div style="font-size:.85rem;color:#444;">
                        <div><strong>${label}</strong></div>
                        <div style="margin-top:.25rem;">${formatTotals(dt)}</div>
                    </div>
                `;

                // week for this selected day
                const dayIndex = d - 1;
                const weekIndex = Math.floor((firstDow + dayIndex) / 7);
                const wt = weekTotals[weekIndex] || emptyTotals();

                weekEl.innerHTML = `
                    <h3 style="margin:0 0 .3rem 0;font-size:.95rem;">Week ${weekIndex + 1}</h3>
                    <p style="color:#666;font-size:.8rem;margin:0 0 .25rem 0;">
                        Total for this week (tracked items only).
                    </p>
                    <div style="font-size:.85rem;">${formatTotals(wt)}</div>
                `;
            }

            // Monthly summary (always shown)
            const totalDays = days || 1;
            const avgTotals = {
                calories: monthTotals.calories / totalDays,
                protein:  monthTotals.protein  / totalDays,
                fat:      monthTotals.fat      / totalDays,
                carbs:    monthTotals.carbs    / totalDays,
                sugars:   monthTotals.sugars   / totalDays,
            };

            monthEl.innerHTML = `
                <h3 style="margin:0 0 .3rem 0;font-size:.95rem;">Monthly Totals</h3>
                <p style="color:#666;font-size:.8rem;margin:0 0 .3rem 0;">
                    Totals and per-day averages for this month (tracked items only).
                </p>
                <div style="font-size:.85rem;">
                    <div><strong>Total:</strong> ${formatTotals(monthTotals)}</div>
                    <div style="margin-top:.15rem;">
                        <strong>Per-day avg:</strong> ${formatTotals(avgTotals)}
                    </div>
                </div>
            `;
        }

        function renderCalendar() {
            const plan = loadPlan();
            const grid = document.getElementById("calendar-grid");
            const clearBtn = document.getElementById("clear-plan");

            grid.innerHTML = "";
            document.getElementById("month-title").textContent =
                `${monthNames[currentMonth]} ${currentYear}`;

            const days = getDaysInMonth(currentMonth, currentYear);
            let anyMeals = false;

            const monthTotals = emptyTotals();
            const weekTotals = [];
            const firstDow = new Date(currentYear, currentMonth, 1).getDay(); // 0=Sun

            // map dateKey -> totals for the sidebar
            const dayTotalsMap = {};

            // initialize default selected day if none yet
            if (!selectedDateKey) {
                const todayInMonth = (
                    today.getFullYear() === currentYear &&
                    today.getMonth() === currentMonth
                );
                if (todayInMonth) {
                    selectedDateKey = `${currentYear}-${currentMonth + 1}-${today.getDate()}`;
                } else {
                    selectedDateKey = `${currentYear}-${currentMonth + 1}-1`;
                }
            }

            for (let day = 1; day <= days; day++) {
                const key = `${currentYear}-${currentMonth + 1}-${day}`;
                const items = plan[key] || [];

                // Sum macros for this day
                const dayTotals = emptyTotals();
                for (const item of items) {
                    if (item.macros) {
                        addTotals(dayTotals, item.macros);
                    }
                }
                dayTotalsMap[key] = dayTotals;
                addTotals(monthTotals, dayTotals);

                const weekIndex = Math.floor((firstDow + (day - 1)) / 7);
                if (!weekTotals[weekIndex]) weekTotals[weekIndex] = emptyTotals();
                addTotals(weekTotals[weekIndex], dayTotals);

                const cell = document.createElement("div");
                cell.style.border = "1px solid #ddd";
                cell.style.borderRadius = ".5rem";
                cell.style.padding = ".5rem";
                cell.style.background = "#fafafa";
                cell.style.display = "flex";
                cell.style.flexDirection = "column";
                cell.style.justifyContent = "space-between";
                cell.style.minHeight = "130px";
                cell.style.cursor = "pointer";

                if (key === selectedDateKey) {
                    cell.style.borderColor = "#4caf50";
                    cell.style.boxShadow = "0 0 0 2px rgba(76,175,80,0.25)";
                    cell.style.background = "#f5fff6";
                }

                const itemsHtml = items.length
                    ? items.map(i => `
                        <div style="display:flex;justify-content:space-between;align-items:center;margin:.15rem 0;">
                            <span>â€¢ ${i.name}${i.brand ? " â€” " + i.brand : ""}</span>
                            <button data-remove="${i.id}"
                                style="font-size:.7rem;border:1px solid #999;border-radius:.3rem;background:#f5f5f5;cursor:pointer;">
                                Remove
                            </button>
                        </div>
                    `).join("")
                    : `<span style="color:#bbb;">No meals</span>`;

                const dayTotalsVal = dayTotals;
                const dayMacrosText =
                    (dayTotalsVal.calories === 0 &&
                     dayTotalsVal.protein === 0 &&
                     dayTotalsVal.fat === 0 &&
                     dayTotalsVal.carbs === 0 &&
                     dayTotalsVal.sugars === 0)
                        ? `<span style="color:#aaa;font-size:.75rem;">Macros: (no tracked items)</span>`
                        : `<span style="color:#444;font-size:.75rem;">${formatTotals(dayTotalsVal)}</span>`;

                cell.innerHTML = `
                    <div>
                        <strong>${day}</strong>
                        <div style="margin-top:.5rem;font-size:.85rem;color:#444;">
                            ${itemsHtml}
                        </div>
                    </div>

                    <div style="margin-top:.4rem;display:flex;flex-direction:column;gap:.25rem;">
                        <div>${dayMacrosText}</div>
                        <button class="add-btn" style="
                            margin-top:.25rem;padding:.25rem .6rem;font-size:.8rem;
                            border:1px solid #999;border-radius:.4rem;cursor:pointer;
                            background:#fff;
                        ">Add</button>
                    </div>
                `;

                // clicking the cell (not on buttons) selects the day for the sidebar
                cell.addEventListener("click", (ev) => {
                    const t = ev.target;
                    if (t && t.nodeType === 1 && t.closest("button")) {
                        return; // let button handlers handle it
                    }
                    selectedDateKey = key;
                    renderCalendar();
                });

                // ADD BUTTON logic
                cell.querySelector(".add-btn").onclick = (ev) => {
                    ev.stopPropagation();
                    const food = document.getElementById("current-food");
                    if (!food) {
                        alert("Search for a food first!");
                        return;
                    }

                    const name = food.dataset.name;
                    const brand = food.dataset.brand;
                    const id = name + "|" + brand;

                    // Per-serving macros from data attributes (USDA or other sources)
                    const macros = {
                        calories: parseFloat(food.dataset.energy || "0") || 0,
                        protein:  parseFloat(food.dataset.protein || "0") || 0,
                        fat:      parseFloat(food.dataset.fat || "0") || 0,
                        carbs:    parseFloat(food.dataset.carbs || "0") || 0,
                        sugars:   parseFloat(food.dataset.sugar || "0") || 0,
                    };

                    const p = loadPlan();
                    p[key] = p[key] || [];

                    if (!p[key].find(x => x.id === id)) {
                        p[key].push({ id, name, brand, macros });
                    }

                    savePlan(p);
                    selectedDateKey = key;
                    renderCalendar();
                };

                // REMOVE BUTTON logic
                cell.querySelectorAll("button[data-remove]").forEach(btn => {
                    btn.onclick = (ev) => {
                        ev.stopPropagation();
                        const id = btn.dataset.remove;

                        const p = loadPlan();
                        p[key] = (p[key] || []).filter(x => x.id !== id);

                        savePlan(p);
                        renderCalendar();
                    };
                });

                if (items.length > 0) anyMeals = true;

                grid.appendChild(cell);
            }

            clearBtn.style.display = anyMeals ? "inline-block" : "none";

            // Update the sidebar with latest aggregates
            updateSidebar(selectedDateKey, dayTotalsMap, weekTotals, monthTotals, days, firstDow);
        }

        document.getElementById("prev-month").onclick = () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        };

        document.getElementById("next-month").onclick = () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        };

        document.getElementById("clear-plan").onclick = () => {
            if (confirm("Clear all meals for this month?")) {
                const p = loadPlan();
                const days = getDaysInMonth(currentMonth, currentYear);
                for (let day = 1; day <= days; day++) {
                    const key = `${currentYear}-${currentMonth + 1}-${day}`;
                    delete p[key];
                }
                savePlan(p);
                renderCalendar();
            }
        };

        document.addEventListener("DOMContentLoaded", renderCalendar);
    </script>

</Layout>
