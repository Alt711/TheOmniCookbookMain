---
export const prerender = false;

import Layout from '../layouts/Layout.astro'
import '../styles/style.css'

/* ---------- helpers ---------- */
function fmtErr(prefix: string, e: unknown) {
    const b = e as any;
    return [
        prefix,
        b?.message && `message: ${b.message}`,
        b?.code && `code: ${b.code}`,
        b?.details && `details: ${b.details}`,
        b?.hint && `hint: ${b.hint}`,
        b?.name && `name: ${b.name}`,
        b?.status && `status: ${b.status}`,
    ].filter(Boolean).join(' | ');
}

type Food = any;
type Nutr = { value: number, unit: string };

const KEY = import.meta.env.FDC_API_KEY;
if (!KEY) throw new Error("Missing FDC_API_KEY");

const query = (Astro.url.searchParams.get("q") || "").trim() || "";

let food: Food | null = null;
let error: { message: string } | null = null;

if (query) {
    try {
        const sUrl = new URL("https://api.nal.usda.gov/fdc/v1/foods/search");
        sUrl.searchParams.set("api_key", KEY);
        sUrl.searchParams.set("query", query);
        sUrl.searchParams.set("pageSize", "1");
        sUrl.searchParams.set("dataType", "Branded,SR Legacy,Survey (FNDDS)");

        const sRes = await fetch(sUrl.toString());
        const sTxt = await sRes.text();
        if (!sRes.ok) throw new Error(`Search HTTP ${sRes.status} | ${sTxt}`);
        const sJson = JSON.parse(sTxt);
        const top = sJson?.foods?.[0];
        if (!top?.fdcId) throw new Error(`No results for '${query}'`);

        const dUrl = new URL(`https://api.nal.usda.gov/fdc/v1/food/${top.fdcId}`);
        dUrl.searchParams.set("api_key", KEY);

        const dRes = await fetch(dUrl.toString());
        const dTxt = await dRes.text();
        if (!dRes.ok) throw new Error(`Details HTTP ${dRes.status} | ${dTxt}`);

        food = JSON.parse(dTxt);
    } catch (e) {
        error = { message: fmtErr("Caught", e) };
    }
}

function buildMap(fd: any) {
    const map = new Map<string, Nutr>();

    for (const n of (fd?.foodNutrients ?? [])) {
        const nm = n.nutrientName ?? n.nutrient?.name;
        const unit = n.unitName ?? n.nutrient?.unitName ?? "";
        const val = n.value ?? n.amount;
        if (nm != null && val != null)
            map.set(String(nm).toLowerCase(), { value: Number(val), unit });
    }

    const ln = fd?.labelNutrients || {};
    const add = (key: string, pretty: string, unit: string) => {
        if (ln[key]?.value != null)
            map.set(pretty.toLowerCase(), { value: ln[key].value, unit });
    };

    add("calories", "Energy", "kcal");
    add("fat", "Total lipid (fat)", "g");
    add("carbohydrates", "Carbohydrate, by difference", "g");
    add("sugars", "Sugars, total", "g");
    add("protein", "Protein", "g");

    return map;
}

const NMAP = food ? buildMap(food) : new Map();

function pickAny(names: string[]) {
    for (const n of names) {
        const hit = NMAP.get(n.toLowerCase());
        if (hit) return hit;
    }
    return { value: null as number | null, unit: "" };
}
function fmt(v: number|null, unit: string) {
    if (v == null) return "‚Äî";
    const fixed = /kcal/i.test(unit) ? v.toFixed(0) : v.toFixed(1);
    return `${fixed} ${unit}`;
}

const S_ENERGY = food ? pickAny(["Energy"]) : { value:null, unit:""};
const S_PRO    = food ? pickAny(["Protein"]) : { value:null, unit:""};
const S_FAT    = food ? pickAny(["Total lipid (fat)"]) : { value:null, unit:""};
const S_CARB   = food ? pickAny(["Carbohydrate, by difference"]) : { value:null, unit:""};
const S_SUGAR  = food ? pickAny(["Sugars, total"]) : { value:null, unit:""};
---

<Layout title="Meal Planner ‚Ä¢ OmniCookBook">

    <!-- NAVBAR -->
    <nav class="top-bar">
        <a href="/" class="page-title">
            <img src="/img/omnilogo.png" width="32" height="32"/>
            OmniCookBook
            <img src="/img/omnilogo.png" width="32" height="32" style="transform:scaleX(-1)"/>
        </a>

        <div class="right-side-lks">
            <a href="/" class="home">Home</a>
            <a href="/about" class="about">About</a>
            <a href="/contact-us" class="contact-us">Contact us</a>
        </div>
    </nav>

    <!-- Buttons -->
    <div class="myfridge-left">
        <a href="/fridge"><button class="myfridgebutton">My Fridge</button></a>
    </div>
    <div class="mealplanner-right">
        <a href="/test"><button class="mealplannerbutton">Meal Planner</button></a>
    </div>

    <!-- Search -->
    <p class="prompt-index">Plan your meals</p>
    <form class="omnisearchbox" method="get" action="/test">
        <input class="omnisearchinput" name="q" value={query} placeholder="Search for foods to add to your meal plan"/>
        <button class="omnisearchbutton">üîç</button>
    </form>

    {error && (
        <pre style="white-space:pre-wrap;background:#fff3f3;border:1px solid #f3b5b5;padding:.75rem;border-radius:.5rem;max-width:800px;margin:1rem auto;">
{error.message}
        </pre>
    )}

    {!error && query && food && (
        <section
            id="current-food"
            style="max-width:800px;margin:1rem auto;"
            data-name={food.description || query}
            data-brand={food.brandOwner || ''}
            data-energy={S_ENERGY.value ?? ''}
            data-protein={S_PRO.value ?? ''}
            data-fat={S_FAT.value ?? ''}
            data-carbs={S_CARB.value ?? ''}
            data-sugar={S_SUGAR.value ?? ''}>

            <div style="background:#f7fbff;border:1px solid #dde8f6;padding:1rem;border-radius:.5rem;">
                <strong>{food.description || query}</strong>
                {food.brandOwner && <> ‚Äî <em>{food.brandOwner}</em></>}
            </div>

            <h3 style="margin-top:1rem;">Per serving</h3>
            <ul style="list-style:none;padding:0;margin:.5rem 0 1rem 0;">
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Energy</span><span>{fmt(S_ENERGY.value, S_ENERGY.unit)}</span>
                </li>
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Protein</span><span>{fmt(S_PRO.value, S_PRO.unit)}</span>
                </li>
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Total Fat</span><span>{fmt(S_FAT.value, S_FAT.unit)}</span>
                </li>
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Carbs</span><span>{fmt(S_CARB.value, S_CARB.unit)}</span>
                </li>
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Sugar</span><span>{fmt(S_SUGAR.value, S_SUGAR.unit)}</span>
                </li>
            </ul>

        </section>
    )}

    <!-- MONTHLY MEAL PLAN -->
    <section style="max-width:900px;margin:2rem auto 3rem auto;">
        <h2>Monthly Meal Planner</h2>
        <p style="color:#666;font-size:.9rem;">Stored in your browser (localStorage)</p>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem;">
            <button id="prev-month" style="padding:.4rem .8rem;border-radius:.4rem;">‚óÄ</button>
            <h3 id="month-title" style="margin:0;"></h3>
            <button id="next-month" style="padding:.4rem .8rem;border-radius:.4rem;">‚ñ∂</button>
        </div>

        <div id="calendar-grid"
            style="display:grid;grid-template-columns:repeat(7,1fr);gap:.75rem;margin-top:1.5rem;">
        </div>

        <!-- WEEKLY + MONTHLY MACRO SUMMARY -->
        <div id="week-summary" style="max-width:900px;margin-top:1.5rem;font-size:.9rem;"></div>
        <div id="month-summary" style="max-width:900px;margin-top:1rem;font-size:.9rem;"></div>

        <button
            id="clear-plan"
            style="display:none;margin-top:1.5rem;padding:.5rem 1rem;border-radius:.4rem;border:1px solid #c62828;background:#c62828;color:white;cursor:pointer;">
            üóë Clear Entire Month
        </button>
    </section>

    <script type="module">
        const KEY = "omni-mealplan-monthly";

        function loadPlan() {
            const raw = localStorage.getItem(KEY);
            return raw ? JSON.parse(raw) : {};
        }
        function savePlan(p) {
            localStorage.setItem(KEY, JSON.stringify(p));
        }

        const today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        const monthNames = [
            "January","February","March","April","May","June",
            "July","August","September","October","November","December"
        ];

        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }

        function emptyTotals() {
            return {
                calories: 0,
                protein: 0,
                fat: 0,
                carbs: 0,
                sugars: 0
            };
        }

        function addTotals(target, src) {
            target.calories += src.calories || 0;
            target.protein  += src.protein  || 0;
            target.fat      += src.fat      || 0;
            target.carbs    += src.carbs    || 0;
            target.sugars   += src.sugars   || 0;
        }

        function formatTotals(t) {
            const kcal = t.calories.toFixed(0);
            const p    = t.protein.toFixed(1);
            const f    = t.fat.toFixed(1);
            const c    = t.carbs.toFixed(1);
            const s    = t.sugars.toFixed(1);
            return `Calories: ${kcal} kcal ¬∑ Protein: ${p} g ¬∑ Fat: ${f} g ¬∑ Carbs: ${c} g ¬∑ Sugar: ${s} g`;
        }

        function renderCalendar() {
            const plan = loadPlan();
            const grid = document.getElementById("calendar-grid");
            const clearBtn = document.getElementById("clear-plan");
            const weekSummaryEl = document.getElementById("week-summary");
            const monthSummaryEl = document.getElementById("month-summary");

            grid.innerHTML = "";
            document.getElementById("month-title").textContent =
                `${monthNames[currentMonth]} ${currentYear}`;

            const days = getDaysInMonth(currentMonth, currentYear);
            let anyMeals = false;

            const monthTotals = emptyTotals();
            const weekTotals = [];
            const firstDow = new Date(currentYear, currentMonth, 1).getDay(); // 0=Sun

            for (let day = 1; day <= days; day++) {
                const key = `${currentYear}-${currentMonth + 1}-${day}`;
                const items = plan[key] || [];

                // Sum macros for this day
                const dayTotals = emptyTotals();
                for (const item of items) {
                    if (item.macros) {
                        addTotals(dayTotals, item.macros);
                    }
                }
                addTotals(monthTotals, dayTotals);

                const weekIndex = Math.floor((firstDow + (day - 1)) / 7);
                if (!weekTotals[weekIndex]) weekTotals[weekIndex] = emptyTotals();
                addTotals(weekTotals[weekIndex], dayTotals);

                const cell = document.createElement("div");
                cell.style.border = "1px solid #ddd";
                cell.style.borderRadius = ".5rem";
                cell.style.padding = ".5rem";
                cell.style.background = "#fafafa";
                cell.style.display = "flex";
                cell.style.flexDirection = "column";
                cell.style.justifyContent = "space-between";
                cell.style.minHeight = "130px";

                const itemsHtml = items.length
                    ? items.map(i => `
                        <div style="display:flex;justify-content:space-between;align-items:center;margin:.15rem 0;">
                            <span>‚Ä¢ ${i.name}${i.brand ? " ‚Äî " + i.brand : ""}</span>
                            <button data-remove="${i.id}"
                                style="font-size:.7rem;border:1px solid #999;border-radius:.3rem;background:#f5f5f5;cursor:pointer;">
                                Remove
                            </button>
                        </div>
                    `).join("")
                    : `<span style="color:#bbb;">No meals</span>`;

                const dayMacrosText =
                    (dayTotals.calories === 0 &&
                     dayTotals.protein === 0 &&
                     dayTotals.fat === 0 &&
                     dayTotals.carbs === 0 &&
                     dayTotals.sugars === 0)
                        ? `<span style="color:#aaa;font-size:.75rem;">Macros: (no tracked items)</span>`
                        : `<span style="color:#444;font-size:.75rem;">${formatTotals(dayTotals)}</span>`;

                cell.innerHTML = `
                    <div>
                        <strong>${day}</strong>
                        <div style="margin-top:.5rem;font-size:.85rem;color:#444;">
                            ${itemsHtml}
                        </div>
                    </div>

                    <div style="margin-top:.4rem;display:flex;flex-direction:column;gap:.25rem;">
                        <div>${dayMacrosText}</div>
                        <button class="add-btn" style="
                            margin-top:.25rem;padding:.25rem .6rem;font-size:.8rem;
                            border:1px solid #999;border-radius:.4rem;cursor:pointer;
                        ">Add</button>
                    </div>
                `;

                // ADD BUTTON logic
                cell.querySelector(".add-btn").onclick = () => {
                    const food = document.getElementById("current-food");
                    if (!food) {
                        alert("Search for a food first!");
                        return;
                    }

                    const name = food.dataset.name;
                    const brand = food.dataset.brand;
                    const id = name + "|" + brand;

                    // Per-serving macros from data attributes (USDA or future sources)
                    const macros = {
                        calories: parseFloat(food.dataset.energy || "0") || 0,
                        protein:  parseFloat(food.dataset.protein || "0") || 0,
                        fat:      parseFloat(food.dataset.fat || "0") || 0,
                        carbs:    parseFloat(food.dataset.carbs || "0") || 0,
                        sugars:   parseFloat(food.dataset.sugar || "0") || 0,
                    };

                    const p = loadPlan();
                    p[key] = p[key] || [];

                    if (!p[key].find(x => x.id === id)) {
                        p[key].push({ id, name, brand, macros });
                    }

                    savePlan(p);
                    renderCalendar();
                };

                // REMOVE BUTTON logic
                cell.querySelectorAll("button[data-remove]").forEach(btn => {
                    btn.onclick = () => {
                        const id = btn.dataset.remove;

                        const p = loadPlan();
                        p[key] = (p[key] || []).filter(x => x.id !== id);

                        savePlan(p);
                        renderCalendar();
                    };
                });

                if (items.length > 0) anyMeals = true;

                grid.appendChild(cell);
            }

            clearBtn.style.display = anyMeals ? "inline-block" : "none";

            // WEEKLY SUMMARY
            if (weekSummaryEl) {
                let html = `<h3 style="margin:0 0 .5rem 0;">Weekly Macro Totals</h3>`;
                html += `<p style="color:#666;font-size:.8rem;margin:0 0 .5rem 0;">Based on items with tracked macros only.</p>`;
                html += `<ul style="list-style:none;padding:0;margin:0;">`;

                weekTotals.forEach((wt, idx) => {
                    if (!wt) return;
                    const weekLabel = `Week ${idx + 1}`;
                    html += `
                        <li style="margin-bottom:.25rem;">
                            <strong>${weekLabel}:</strong>
                            <span style="margin-left:.25rem;">${formatTotals(wt)}</span>
                        </li>
                    `;
                });

                html += `</ul>`;
                weekSummaryEl.innerHTML = html;
            }

            // MONTHLY SUMMARY
            if (monthSummaryEl) {
                const totalDays = days;
                const avgTotals = {
                    calories: monthTotals.calories / totalDays,
                    protein:  monthTotals.protein / totalDays,
                    fat:      monthTotals.fat / totalDays,
                    carbs:    monthTotals.carbs / totalDays,
                    sugars:   monthTotals.sugars / totalDays,
                };

                monthSummaryEl.innerHTML = `
                    <h3 style="margin:.75rem 0 .3rem 0;">Monthly Macro Totals</h3>
                    <p style="color:#666;font-size:.8rem;margin:0 0 .4rem 0;">
                        Totals and per-day averages for this month (tracked items only).
                    </p>
                    <div style="font-size:.9rem;">
                        <div><strong>Total:</strong> ${formatTotals(monthTotals)}</div>
                        <div style="margin-top:.15rem;">
                            <strong>Per-day avg:</strong>
                            ${formatTotals(avgTotals)}
                        </div>
                    </div>
                `;
            }
        }

        document.getElementById("prev-month").onclick = () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        };

        document.getElementById("next-month").onclick = () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        };

        document.getElementById("clear-plan").onclick = () => {
            if (confirm("Clear all meals for this month?")) {
                const p = loadPlan();
                const days = getDaysInMonth(currentMonth, currentYear);
                for (let day = 1; day <= days; day++) {
                    const key = `${currentYear}-${currentMonth + 1}-${day}`;
                    delete p[key];
                }
                savePlan(p);
                renderCalendar();
            }
        };

        document.addEventListener("DOMContentLoaded", renderCalendar);
    </script>

</Layout>
