---
export const prerender = false;

import Layout from '../layouts/Layout.astro'
import '../styles/style.css'

/* ---------- helpers ---------- */
function fmtErr(prefix: string, e: unknown) {
    const b = e as any
    return [
        prefix,
        b?.message && `message: ${b.message}`,
        b?.code && `code: ${b.code}`,
        b?.details && `details: ${b.details}`,
        b?.hint && `hint: ${b.hint}`,
        b?.name && `name: ${b.name}`,
        b?.status && `status: ${b.status}`,
    ].filter(Boolean).join(' | ')
}

type Food = any;
type Nutr = { value: number, unit: string };

const KEY = import.meta.env.FDC_API_KEY;
if (!KEY) throw new Error("Missing FDC_API_KEY");

// read query ?q=
const query = (Astro.url.searchParams.get("q") || "").trim() || "";

let food: Food | null = null;
let error: { message: string } | null = null;

if (query) {
    try {
        // search
        const sUrl = new URL("https://api.nal.usda.gov/fdc/v1/foods/search");
        sUrl.searchParams.set("api_key", KEY);
        sUrl.searchParams.set("query", query);
        sUrl.searchParams.set("pageSize", "1");
        sUrl.searchParams.set("dataType", "Branded,SR Legacy,Survey (FNDDS)");

        const sRes = await fetch(sUrl.toString());
        const sTxt = await sRes.text();
        if (!sRes.ok) throw new Error(`Search HTTP ${sRes.status} | ${sTxt}`);
        const sJson = JSON.parse(sTxt);
        const top = sJson?.foods?.[0];
        if (!top?.fdcId) throw new Error(`No results for '${query}'`);

        // details
        const dUrl = new URL(`https://api.nal.usda.gov/fdc/v1/food/${top.fdcId}`);
        dUrl.searchParams.set("api_key", KEY);

        const dRes = await fetch(dUrl.toString());
        const dTxt = await dRes.text();
        if (!dRes.ok) throw new Error(`Details HTTP ${dRes.status} | ${dTxt}`);

        food = JSON.parse(dTxt);
    } catch (e) {
        error = { message: fmtErr("Caught", e) };
    }
}

// nutrient normalization
function buildMap(fd: any) {
    const map = new Map<string, Nutr>();

    // list
    for (const n of (fd?.foodNutrients ?? [])) {
        const nm = n.nutrientName ?? n.nutrient?.name;
        const unit = n.unitName ?? n.nutrient?.unitName ?? "";
        const val = n.value ?? n.amount;
        if (nm != null && val != null)
            map.set(String(nm).toLowerCase(), { value: Number(val), unit });
    }

    // labelNutrients
    const ln = fd?.labelNutrients || {};
    const add = (key: string, pretty: string, unit: string) => {
        if (ln[key]?.value != null)
            map.set(pretty.toLowerCase(), { value: ln[key].value, unit });
    };

    add("calories", "Energy", "kcal");
    add("fat", "Total lipid (fat)", "g");
    add("carbohydrates", "Carbohydrate, by difference", "g");
    add("sugars", "Sugars, total", "g");
    add("protein", "Protein", "g");

    return map;
}

const NMAP = food ? buildMap(food) : new Map();

function pickAny(candidates: string[]) {
    for (const c of candidates) {
        const hit = NMAP.get(c.toLowerCase());
        if (hit) return hit;
    }
    return { value: null, unit: "" };
}
function fmt(v: number|null, unit: string) {
    if (v == null) return "‚Äî";
    const fixed = /kcal/i.test(unit) ? v.toFixed(0) : v.toFixed(1);
    return `${fixed} ${unit}`;
}

const S_ENERGY = food ? pickAny(["Energy", "Energy (Atwater General Factors)"]) : { value:null, unit:""};
const S_PRO    = food ? pickAny(["Protein"]) : {value:null, unit:""};
const S_FAT    = food ? pickAny(["Total lipid (fat)"]) : {value:null, unit:""};
const S_CARB   = food ? pickAny(["Carbohydrate, by difference"]) : {value:null, unit:""};
const S_SUGAR  = food ? pickAny(["Sugars, total"]) : {value:null, unit:""};
---

<Layout title="Meal Planner ‚Ä¢ OmniCookBook">

    <!-- NAVBAR -->
    <nav class="top-bar">
        <a href="/" class="page-title">
            <img src="/img/omnilogo.png" width="32" height="32"/>
            OmniCookBook
            <img src="/img/omnilogo.png" style="transform:scaleX(-1)" width="32" height="32"/>
        </a>

        <div class="right-side-lks">
            <a href="/" class="home">Home</a>
            <a href="/about" class="about">About</a>
            <a href="/contact-us" class="contact-us">Contact us</a>
        </div>
    </nav>

    <!-- Buttons -->
    <div class="myfridge-left">
        <a href="/fridge"><button class="myfridgebutton">My Fridge</button></a>
    </div>
    <div class="mealplanner-right">
        <a href="/test"><button class="mealplannerbutton">Meal Planner</button></a>
    </div>

    <!-- Search -->
    <p class="prompt-index">Plan your meals</p>
    <form class="omnisearchbox" method="get" action="/test">
        <input 
            class="omnisearchinput"
            name="q"
            value={query}
            placeholder="Search for foods to add to your meal plan"
        />
        <button class="omnisearchbutton">üîç</button>
    </form>

    {error && (
        <pre style="white-space:pre-wrap;background:#fff3f3;border:1px solid #f3b5b5;padding:.75rem;border-radius:.5rem;max-width:800px;margin:1rem auto;">
{error.message}
        </pre>
    )}

    {!error && query && food && (
        <section id="current-food"
            style="max-width:800px;margin:1rem auto;"
            data-name={food.description || query}
            data-brand={food.brandOwner || ''}
        >
            <div style="background:#f7fbff;border:1px solid #dde8f6;padding:1rem;border-radius:.5rem;">
                <strong>{food.description || query}</strong>
                {food.brandOwner && <> ‚Äî <em>{food.brandOwner}</em></>}
            </div>

            <h3 style="margin-top:1rem;">Per serving</h3>
            <ul style="list-style:none;padding:0;margin:.5rem 0 1rem 0;">
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Energy</span><span>{fmt(S_ENERGY.value, S_ENERGY.unit)}</span>
                </li>
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Protein</span><span>{fmt(S_PRO.value, S_PRO.unit)}</span>
                </li>
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Total Fat</span><span>{fmt(S_FAT.value, S_FAT.unit)}</span>
                </li>
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Carbs</span><span>{fmt(S_CARB.value, S_CARB.unit)}</span>
                </li>
                <li style="display:flex;justify-content:space-between;border-bottom:1px dashed #ddd;padding:.5rem 0;">
                    <span>Sugar</span><span>{fmt(S_SUGAR.value, S_SUGAR.unit)}</span>
                </li>
            </ul>

            <label for="day-select"><strong>Choose a day:</strong></label>
            <select id="day-select" style="margin-left:.5rem;padding:.3rem;">
                <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
                <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
            </select>

            <button 
                id="add-to-plan"
                style="margin-left:1rem;padding:.45rem 1rem;border-radius:.4rem;border:1px solid #4caf50;background:#4caf50;color:white;cursor:pointer;">
                ‚ûï Add to Meal Plan
            </button>
        </section>
    )}

    <!-- MEAL PLAN -->
    <section style="max-width:800px;margin:2rem auto 3rem auto;">
        <h2>Weekly Meal Plan</h2>
        <p style="color:#666;font-size:.9rem;">Stored in your browser (localStorage)</p>

        <div id="mealplan-container" style="margin-top:1rem;"></div>

        <button
            id="clear-plan"
            style="display:none;margin-top:.8rem;padding:.5rem 1rem;border-radius:.4rem;border:1px solid #c62828;background:#c62828;color:white;cursor:pointer;">
            üóë Clear Meal Plan
        </button>
    </section>

    <!-- Client JS -->
    <script type="module">
        const KEY = "omni-mealplan";

        function loadPlan() {
            const raw = localStorage.getItem(KEY);
            return raw ? JSON.parse(raw) : {
                Monday:[], Tuesday:[], Wednesday:[], Thursday:[],
                Friday:[], Saturday:[], Sunday:[]
            };
        }

        function savePlan(p) {
            localStorage.setItem(KEY, JSON.stringify(p));
        }

        function render() {
            const box = document.getElementById("mealplan-container");
            const clearBtn = document.getElementById("clear-plan");
            const plan = loadPlan();
            box.innerHTML = "";

            let empty = true;

            for (const day of Object.keys(plan)) {
                const items = plan[day];

                const section = document.createElement("div");
                section.style.marginBottom = "1.2rem";

                const h = document.createElement("h3");
                h.textContent = day;
                h.style.marginBottom = ".4rem";
                section.appendChild(h);

                if (items.length === 0) {
                    const p = document.createElement("p");
                    p.textContent = "No meals added.";
                    p.style.color = "#777";
                    section.appendChild(p);
                } else {
                    empty = false;
                    for (const meal of items) {
                        const row = document.createElement("div");
                        row.style.display = "flex";
                        row.style.justifyContent = "space-between";
                        row.style.borderBottom = "1px dashed #ddd";
                        row.style.padding = ".3rem 0";

                        row.innerHTML = `
                            <span>${meal.name}${meal.brand ? " ‚Äî " + meal.brand : ""}</span>
                        `;

                        const btn = document.createElement("button");
                        btn.textContent = "Remove";
                        btn.style.fontSize = ".8rem";
                        btn.style.cursor = "pointer";
                        btn.style.border = "1px solid #999";
                        btn.style.borderRadius = ".4rem";
                        btn.style.background = "#f5f5f5";

                        btn.onclick = () => {
                            const p2 = loadPlan();
                            p2[day] = p2[day].filter(x => x.id !== meal.id);
                            savePlan(p2);
                            render();
                        };

                        row.appendChild(btn);
                        section.appendChild(row);
                    }
                }

                box.appendChild(section);
            }

            clearBtn.style.display = empty ? "none" : "inline-block";
        }

        document.addEventListener("DOMContentLoaded", () => {
            render();

            const btn = document.getElementById("add-to-plan");
            const food = document.getElementById("current-food");
            const daySel = document.getElementById("day-select");
            const clearBtn = document.getElementById("clear-plan");

            if (btn && food) {
                btn.onclick = () => {
                    const name = food.dataset.name;
                    const brand = food.dataset.brand;
                    const id = name + "|" + brand;

                    const plan = loadPlan();
                    const day = daySel.value;

                    // avoid duplicates
                    if (!plan[day].find(x => x.id === id))
                        plan[day].push({ id, name, brand });

                    savePlan(plan);
                    render();
                };
            }

            if (clearBtn) {
                clearBtn.onclick = () => {
                    if (confirm("Clear your entire meal plan?")) {
                        localStorage.removeItem(KEY);
                        render();
                    }
                };
            }
        });
    </script>
</Layout>
